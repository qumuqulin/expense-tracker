<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>æœˆåº¦èŠ±é”€è®°è´¦è¡¨ - äº‘ç«¯ç‰ˆ</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
* { box-sizing: border-box; }
body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont;
    background: #f5f6fa;
    margin: 0;
    padding: 16px;
}

.container {
    max-width: 1200px;
    margin: auto;
    background: #fff;
    border-radius: 12px;
    padding: 16px;
    box-shadow: 0 5px 15px rgba(0,0,0,.08);
}

h1 {
    text-align: center;
    margin-bottom: 16px;
}

/* ===== é…ç½®åŒº ===== */
.config-panel {
    background: #f8f9fa;
    padding: 16px;
    border-radius: 8px;
    margin-bottom: 16px;
    border-left: 4px solid #3498db;
}

.config-panel.hidden {
    display: none;
}

.config-input {
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    width: 100%;
    margin-bottom: 8px;
}

.config-btn {
    background: #3498db;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    margin-right: 8px;
    margin-bottom: 8px;
}

.config-btn:hover {
    opacity: .9;
}

.config-btn.success {
    background: #2ecc71;
}

.config-btn.warning {
    background: #f39c12;
}

/* ===== æ§åˆ¶åŒº ===== */
.controls {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-bottom: 16px;
}

.controls select,
.controls button {
    padding: 8px 12px;
    border-radius: 6px;
    border: 1px solid #ddd;
    background: #fff;
}

.controls button {
    cursor: pointer;
    background: #3498db;
    color: #fff;
    border: none;
}

.controls button:hover {
    opacity: .9;
}

.controls button.green {
    background: #2ecc71;
}

.controls button.red {
    background: #e74c3c;
}

/* ===== çŠ¶æ€æç¤º ===== */
.status {
    padding: 10px;
    border-radius: 4px;
    margin: 10px 0;
    display: none;
}

.status.success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
    display: block;
}

.status.error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
    display: block;
}

.status.info {
    background: #d1ecf1;
    color: #0c5460;
    border: 1px solid #bee5eb;
    display: block;
}

/* ===== è‡ªå®šä¹‰ç±»å‹ ===== */
.custom-type {
    margin-bottom: 16px;
    padding: 12px;
    background: #f8f9fa;
    border-radius: 8px;
}

.custom-type input {
    padding: 8px;
    width: 160px;
    margin-right: 8px;
}

#type-list {
    margin-top: 8px;
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
}

.type-tag {
    background: #3498db;
    color: #fff;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    cursor: pointer;
    display: inline-block;
    margin-bottom: 4px;
}

/* ===== è¡¨æ ¼ ===== */
.table-wrap {
    overflow-x: auto;
}

table {
    border-collapse: collapse;
    width: 100%;
    min-width: 650px;
}

th, td {
    padding: 8px;
    border-bottom: 1px solid #ddd;
}

th {
    background: #f8f9fa;
}

input, select {
    width: 100%;
    padding: 4px;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.delete {
    background: #e74c3c;
    color: #fff;
    border: none;
    padding: 6px 8px;
    border-radius: 4px;
    cursor: pointer;
}

/* ===== ç»Ÿè®¡ ===== */
.summary {
    margin-top: 16px;
    background: #f8f9fa;
    padding: 12px;
    border-radius: 8px;
}

.summary strong {
    font-size: 18px;
}

/* ===== æ‰‹æœºé€‚é… ===== */
@media (max-width: 768px) {
    .controls, .config-buttons {
        flex-direction: column;
    }

    .controls select,
    .controls button,
    .config-btn {
        width: 100%;
        margin-bottom: 8px;
    }
    
    .config-btn {
        margin-right: 0;
    }
}
</style>
</head>

<body>
<div class="container">
    <h1>ğŸ“Š æœˆåº¦èŠ±é”€è®°è´¦è¡¨ - äº‘ç«¯ç‰ˆ</h1>
    
    <!-- é…ç½®é¢æ¿ -->
    <div class="config-panel" id="configPanel">
        <h3>ğŸ”§ Supabase é…ç½®</h3>
        <p>é¦–æ¬¡ä½¿ç”¨è¯·é…ç½®äº‘ç«¯å­˜å‚¨ï¼ˆé…ç½®ä¼šè‡ªåŠ¨ä¿å­˜ï¼‰</p>
        <input type="text" id="supabaseUrl" class="config-input" 
               placeholder="Supabase URL (å¦‚ï¼šhttps://xxx.supabase.co)">
        <input type="text" id="supabaseKey" class="config-input" 
               placeholder="Supabase Anon Key">
        <input type="text" id="tableName" class="config-input" 
               placeholder="è¡¨åï¼ˆé»˜è®¤ï¼šexpensesï¼‰" value="expenses">
        <div class="config-buttons">
            <button class="config-btn success" onclick="saveConfig()">ğŸ’¾ ä¿å­˜é…ç½®</button>
            <button class="config-btn" onclick="testConnection()">ğŸ”— æµ‹è¯•è¿æ¥</button>
            <button class="config-btn warning" onclick="createTable()">ğŸ› ï¸ åˆ›å»ºè¡¨</button>
            <button class="config-btn" onclick="hideConfig()">éšè—é…ç½®</button>
        </div>
        <div id="sqlHelp" style="margin-top: 10px; display: none;">
            <h4>ğŸ“‹ SQLåˆ›å»ºè¡¨è¯­å¥ï¼š</h4>
            <pre style="background: #eee; padding: 10px; border-radius: 4px; overflow: auto;">
CREATE TABLE expenses (
  id BIGSERIAL PRIMARY KEY,
  year INTEGER NOT NULL,
  month INTEGER NOT NULL,
  expense_date DATE NOT NULL,
  category VARCHAR(50) NOT NULL,
  amount DECIMAL(10,2) NOT NULL,
  note TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- å¯ç”¨RLSå¹¶è®¾ç½®ç­–ç•¥
ALTER TABLE expenses ENABLE ROW LEVEL SECURITY;

CREATE POLICY "å…è®¸æ‰€æœ‰äººæ“ä½œexpensesè¡¨" ON expenses
  FOR ALL USING (true);
            </pre>
        </div>
    </div>
    
    <!-- çŠ¶æ€æç¤º -->
    <div id="status" class="status"></div>
    
    <!-- æ§åˆ¶åŒº -->
    <div class="controls" id="mainControls" style="display:none;">
        <select id="year"></select>
        <select id="month"></select>
        <button id="addRow" class="green">ï¼‹ æ·»åŠ è®°å½•</button>
        <button id="export">ğŸ“¤ å¯¼å‡º Excel</button>
        <button onclick="syncData()" class="green">ğŸ”„ åŒæ­¥äº‘ç«¯</button>
        <button onclick="loadCloudData()" class="green">ğŸ“¥ åŠ è½½äº‘ç«¯</button>
        <button onclick="showConfig()" class="config-btn">âš™ï¸ é…ç½®</button>
    </div>

    <!-- è‡ªå®šä¹‰ç±»å‹ -->
    <div class="custom-type">
        <input id="newType" placeholder="æ–°å¢ç±»å‹" />
        <button onclick="addCustomType()" class="config-btn">æ·»åŠ ç±»å‹</button>
        <div id="type-list"></div>
    </div>

    <!-- è¡¨æ ¼ -->
    <div class="table-wrap">
        <table>
            <thead>
                <tr>
                    <th>æ—¥æœŸ</th>
                    <th>ç±»å‹</th>
                    <th>é‡‘é¢</th>
                    <th>å¤‡æ³¨</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="tbody"></tbody>
        </table>
    </div>

    <!-- ç»Ÿè®¡ -->
    <div class="summary">
        <strong>æ€»è®¡ï¼šÂ¥ <span id="total">0</span></strong>
        <div id="detail"></div>
    </div>
</div>

<script>
/* ========= å…¨å±€å˜é‡ ========= */
const baseTypes = ["é£Ÿç‰©", "å‡ºè¡Œ", "æ°´ç”µ", "æˆ¿ç§Ÿ", "è´­ç‰©", "å¨±ä¹", "åŒ»ç–—", "å…¶ä»–"];
let customTypes = JSON.parse(localStorage.getItem("customTypes") || "[]");
let localExpenses = {}; // æœ¬åœ°ç¼“å­˜ï¼š{ "2024-1": [ {date, category, amount, note} ] }
let supabaseClient = null;
let currentConfig = null;

const yearEl = document.getElementById("year");
const monthEl = document.getElementById("month");
const tbody = document.getElementById("tbody");

/* ========= åˆå§‹åŒ– ========= */
function init() {
    // åˆå§‹åŒ–å¹´æœˆé€‰æ‹©
    const now = new Date();
    const currentYear = now.getFullYear();
    
    for (let y = currentYear - 5; y <= currentYear + 1; y++) {
        yearEl.add(new Option(y, y));
    }
    yearEl.value = currentYear;

    ["1æœˆ","2æœˆ","3æœˆ","4æœˆ","5æœˆ","6æœˆ","7æœˆ","8æœˆ","9æœˆ","10æœˆ","11æœˆ","12æœˆ"].forEach((m,i)=>{
        monthEl.add(new Option(m, i));
    });
    monthEl.value = now.getMonth();
    
    // åŠ è½½é…ç½®
    loadConfig();
    renderTypes();
    
    // åˆå§‹åŒ–æœ¬åœ°æ•°æ®
    loadLocalData();
}

/* ========= é…ç½®ç®¡ç† ========= */
function loadConfig() {
    const savedConfig = localStorage.getItem('supabaseConfig');
    if (savedConfig) {
        currentConfig = JSON.parse(savedConfig);
        document.getElementById('supabaseUrl').value = currentConfig.url || '';
        document.getElementById('supabaseKey').value = currentConfig.key || '';
        document.getElementById('tableName').value = currentConfig.tableName || 'expenses';
        
        if (currentConfig.url && currentConfig.key) {
            initSupabase();
        }
    }
}

function saveConfig() {
    const url = document.getElementById('supabaseUrl').value.trim();
    const key = document.getElementById('supabaseKey').value.trim();
    const tableName = document.getElementById('tableName').value.trim() || 'expenses';

    if (!url || !key) {
        showStatus('è¯·å¡«å†™å®Œæ•´çš„é…ç½®ä¿¡æ¯', 'error');
        return;
    }

    currentConfig = { url, key, tableName };
    localStorage.setItem('supabaseConfig', JSON.stringify(currentConfig));
    showStatus('é…ç½®å·²ä¿å­˜ï¼', 'success');
    
    initSupabase();
}

function initSupabase() {
    try {
        supabaseClient = window.supabase.createClient(
            currentConfig.url,
            currentConfig.key
        );
        
        document.getElementById('configPanel').classList.add('hidden');
        document.getElementById('mainControls').style.display = 'flex';
        showStatus('äº‘ç«¯è¿æ¥æˆåŠŸï¼æ­£åœ¨åŠ è½½æ•°æ®...', 'success');
        
        // æµ‹è¯•è¡¨æ˜¯å¦å­˜åœ¨
        checkTableExists();
    } catch (error) {
        showStatus('åˆå§‹åŒ–å¤±è´¥ï¼š' + error.message, 'error');
    }
}

function showConfig() {
    document.getElementById('configPanel').classList.remove('hidden');
    document.getElementById('sqlHelp').style.display = 'block';
}

function hideConfig() {
    document.getElementById('configPanel').classList.add('hidden');
}

async function testConnection() {
    const url = document.getElementById('supabaseUrl').value.trim();
    const key = document.getElementById('supabaseKey').value.trim();
    const tableName = document.getElementById('tableName').value.trim() || 'expenses';

    if (!url || !key) {
        showStatus('è¯·å…ˆå¡«å†™é…ç½®ä¿¡æ¯', 'error');
        return;
    }

    showStatus('æ­£åœ¨æµ‹è¯•è¿æ¥...', 'info');

    try {
        const testClient = window.supabase.createClient(url, key);
        const { data, error } = await testClient
          .from(tableName)
          .select('*')
          .limit(1);

        if (error) {
            if (error.message.includes('does not exist')) {
                showStatus(`è¡¨ "${tableName}" ä¸å­˜åœ¨ï¼Œè¯·ç‚¹å‡»"åˆ›å»ºè¡¨"æŒ‰é’®`, 'error');
                document.getElementById('sqlHelp').style.display = 'block';
            } else {
                showStatus('è¿æ¥å¤±è´¥ï¼š' + error.message, 'error');
            }
        } else {
            showStatus('âœ… è¿æ¥æˆåŠŸï¼è¡¨å·²å­˜åœ¨', 'success');
        }
    } catch (error) {
        showStatus('è¿æ¥æµ‹è¯•å¼‚å¸¸ï¼š' + error.message, 'error');
    }
}

/* ========= è¡¨ç®¡ç† ========= */
async function checkTableExists() {
    if (!supabaseClient) return;
    
    try {
        const { error } = await supabaseClient
            .from(currentConfig.tableName)
            .select('id')
            .limit(1);
            
        if (error && error.message.includes('does not exist')) {
            showStatus('è¡¨ä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»ºè¡¨', 'error');
            document.getElementById('sqlHelp').style.display = 'block';
        } else {
            loadCloudData();
        }
    } catch (err) {
        console.error('æ£€æŸ¥è¡¨å¤±è´¥:', err);
    }
}

async function createTable() {
    const sql = `
CREATE TABLE IF NOT EXISTS expenses (
  id BIGSERIAL PRIMARY KEY,
  year INTEGER NOT NULL,
  month INTEGER NOT NULL,
  expense_date DATE NOT NULL,
  category VARCHAR(50) NOT NULL,
  amount DECIMAL(10,2) NOT NULL,
  note TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- å¯ç”¨RLS
ALTER TABLE expenses ENABLE ROW LEVEL SECURITY;

-- åˆ›å»ºç­–ç•¥ï¼ˆå…è®¸æ‰€æœ‰äººè¯»å†™ï¼‰
CREATE POLICY "å…è®¸æ‰€æœ‰äººæ“ä½œexpensesè¡¨" ON expenses
  FOR ALL USING (true);
    `;
    
    showStatus('è¯·åœ¨Supabaseæ§åˆ¶å°çš„SQLç¼–è¾‘å™¨ä¸­æ‰§è¡Œä»¥ä¸‹è¯­å¥ï¼š', 'info');
    alert('è¯·ç™»å½•Supabaseæ§åˆ¶å°ï¼Œè¿›å…¥SQLç¼–è¾‘å™¨ï¼Œç²˜è´´å¹¶æ‰§è¡Œä»¥ä¸‹SQLè¯­å¥ï¼š\n\n' + sql);
    
    // ä¹Ÿå¯ä»¥å°è¯•é€šè¿‡APIåˆ›å»ºï¼ˆä½†é€šå¸¸éœ€è¦service_roleæƒé™ï¼‰
    try {
        const testClient = window.supabase.createClient(
            document.getElementById('supabaseUrl').value.trim(),
            document.getElementById('supabaseKey').value.trim()
        );
        
        // å°è¯•æ’å…¥æµ‹è¯•æ•°æ®æ¥éšå¼åˆ›å»ºè¡¨ï¼ˆå¦‚æœè¡¨ä¸å­˜åœ¨ä¼šå¤±è´¥ï¼‰
        const { error } = await testClient
            .from('expenses')
            .insert({
                year: 2024,
                month: 1,
                expense_date: new Date().toISOString().split('T')[0],
                category: 'æµ‹è¯•',
                amount: 0.01,
                note: 'æµ‹è¯•æ•°æ®'
            });
            
        if (!error || error.message.includes('duplicate key')) {
            showStatus('è¡¨å¯èƒ½å·²å­˜åœ¨ï¼Œè¯·æµ‹è¯•è¿æ¥', 'success');
        }
    } catch (err) {
        showStatus('è¯·æ‰‹åŠ¨åœ¨Supabaseä¸­åˆ›å»ºè¡¨', 'info');
    }
}

/* ========= çŠ¶æ€æ˜¾ç¤º ========= */
function showStatus(message, type = 'info') {
    const statusDiv = document.getElementById('status');
    statusDiv.innerHTML = message;
    statusDiv.className = 'status ' + type;
    
    // 5ç§’åè‡ªåŠ¨éšè—
    if (type !== 'error') {
        setTimeout(() => {
            statusDiv.className = 'status';
        }, 5000);
    }
}

/* ========= ç±»å‹ç®¡ç† ========= */
function renderTypes() {
    const list = document.getElementById("type-list");
    list.innerHTML = "";
    customTypes.forEach(t => {
        const tag = document.createElement("div");
        tag.className = "type-tag";
        tag.textContent = t + " Ã—";
        tag.onclick = () => {
            customTypes = customTypes.filter(x => x !== t);
            localStorage.setItem("customTypes", JSON.stringify(customTypes));
            renderTypes();
            loadCurrentMonth();
        };
        list.appendChild(tag);
    });
}

function addCustomType() {
    const newTypeInput = document.getElementById("newType");
    const v = newTypeInput.value.trim();
    if (!v || baseTypes.includes(v) || customTypes.includes(v)) {
        showStatus('ç±»å‹å·²å­˜åœ¨æˆ–ä¸ºç©º', 'error');
        return;
    }
    customTypes.push(v);
    localStorage.setItem("customTypes", JSON.stringify(customTypes));
    newTypeInput.value = "";
    renderTypes();
    loadCurrentMonth();
    showStatus('ç±»å‹æ·»åŠ æˆåŠŸ', 'success');
}

/* ========= æ•°æ®ç®¡ç† ========= */
function getCurrentKey() {
    return `${yearEl.value}-${monthEl.value}`;
}

// æ·»åŠ è¡Œ
function addRow(data = {}) {
    const tr = document.createElement("tr");

    const typeOptions = [...baseTypes, ...customTypes]
        .map(t => `<option ${t===data.category?'selected':''}>${t}</option>`).join("");

    tr.innerHTML = `
        <td><input type="date" class="date-input" value="${data.expense_date || new Date().toISOString().slice(0,10)}"></td>
        <td><select class="category-select">${typeOptions}</select></td>
        <td><input type="number" step="0.01" class="amount-input" value="${data.amount||''}" placeholder="0.00"></td>
        <td><input class="note-input" value="${data.note||''}" placeholder="å¤‡æ³¨"></td>
        <td><button class="delete">åˆ é™¤</button></td>
    `;

    tr.querySelector(".delete").onclick = async () => {
        // å¦‚æœæ•°æ®å·²åŒæ­¥åˆ°äº‘ç«¯ï¼Œå°è¯•åˆ é™¤äº‘ç«¯è®°å½•
        if (data.id && supabaseClient) {
            try {
                await supabaseClient
                    .from(currentConfig.tableName)
                    .delete()
                    .eq('id', data.id);
                showStatus('äº‘ç«¯è®°å½•å·²åˆ é™¤', 'success');
            } catch (err) {
                console.error('åˆ é™¤äº‘ç«¯è®°å½•å¤±è´¥:', err);
            }
        }
        
        tr.remove();
        saveLocalData();
    };

    tr.querySelectorAll("input,select").forEach(el => el.oninput = () => {
        saveLocalData();
    });
    
    tbody.appendChild(tr);
}

// ä¿å­˜æœ¬åœ°æ•°æ®
function saveLocalData() {
    const rows = [...tbody.children].map(tr => {
        const inputs = tr.querySelectorAll("input,select");
        return {
            id: tr.dataset.id || null,
            expense_date: inputs[0].value,
            category: inputs[1].value,
            amount: parseFloat(inputs[2].value) || 0,
            note: inputs[3].value
        };
    });
    
    const key = getCurrentKey();
    localExpenses[key] = rows;
    localStorage.setItem('localExpenses', JSON.stringify(localExpenses));
    calc();
}

// åŠ è½½æœ¬åœ°æ•°æ®
function loadLocalData() {
    const saved = localStorage.getItem('localExpenses');
    if (saved) {
        localExpenses = JSON.parse(saved);
    }
    loadCurrentMonth();
}

// åŠ è½½å½“å‰æœˆä»½æ•°æ®
function loadCurrentMonth() {
    tbody.innerHTML = "";
    const key = getCurrentKey();
    const rows = localExpenses[key] || [];
    rows.forEach(row => {
        const tr = addRow(row);
        if (row.id) {
            tr.dataset.id = row.id;
        }
    });
    calc();
}

// ä»äº‘ç«¯åŠ è½½æ•°æ®
async function loadCloudData() {
    if (!supabaseClient || !currentConfig) {
        showStatus('è¯·å…ˆé…ç½®äº‘ç«¯è¿æ¥', 'error');
        return;
    }
    
    showStatus('æ­£åœ¨ä»äº‘ç«¯åŠ è½½æ•°æ®...', 'info');
    
    try {
        const year = parseInt(yearEl.value);
        const month = parseInt(monthEl.value);
        
        const { data, error } = await supabaseClient
            .from(currentConfig.tableName)
            .select('*')
            .eq('year', year)
            .eq('month', month)
            .order('expense_date', { ascending: false });
            
        if (error) {
            showStatus('åŠ è½½äº‘ç«¯æ•°æ®å¤±è´¥ï¼š' + error.message, 'error');
            return;
        }
        
        console.log('äº‘ç«¯æ•°æ®:', data);
        
        // æ¸…ç©ºå½“å‰è¡¨æ ¼
        tbody.innerHTML = "";
        
        // æ˜¾ç¤ºäº‘ç«¯æ•°æ®
        if (data && data.length > 0) {
            data.forEach(item => {
                addRow({
                    id: item.id,
                    expense_date: item.expense_date,
                    category: item.category,
                    amount: item.amount,
                    note: item.note
                });
            });
            
            // ä¿å­˜åˆ°æœ¬åœ°
            const key = getCurrentKey();
            localExpenses[key] = data.map(item => ({
                id: item.id,
                expense_date: item.expense_date,
                category: item.category,
                amount: item.amount,
                note: item.note
            }));
            
            localStorage.setItem('localExpenses', JSON.stringify(localExpenses));
            showStatus(`ä»äº‘ç«¯åŠ è½½äº† ${data.length} æ¡è®°å½•`, 'success');
        } else {
            showStatus('äº‘ç«¯æ²¡æœ‰è¯¥æœˆä»½çš„æ•°æ®', 'info');
        }
        
        calc();
    } catch (error) {
        showStatus('åŠ è½½äº‘ç«¯æ•°æ®å¼‚å¸¸ï¼š' + error.message, 'error');
    }
}

// åŒæ­¥æ•°æ®åˆ°äº‘ç«¯
async function syncData() {
    if (!supabaseClient || !currentConfig) {
        showStatus('è¯·å…ˆé…ç½®äº‘ç«¯è¿æ¥', 'error');
        return;
    }
    
    showStatus('æ­£åœ¨åŒæ­¥åˆ°äº‘ç«¯...', 'info');
    
    try {
        const year = parseInt(yearEl.value);
        const month = parseInt(monthEl.value);
        const rows = [...tbody.children];
        
        let successCount = 0;
        let errorCount = 0;
        
        for (const tr of rows) {
            const inputs = tr.querySelectorAll("input,select");
            const rowData = {
                year: year,
                month: month,
                expense_date: inputs[0].value,
                category: inputs[1].value,
                amount: parseFloat(inputs[2].value) || 0,
                note: inputs[3].value
            };
            
            const rowId = tr.dataset.id;
            
            try {
                if (rowId) {
                    // æ›´æ–°ç°æœ‰è®°å½•
                    const { error } = await supabaseClient
                        .from(currentConfig.tableName)
                        .update(rowData)
                        .eq('id', rowId);
                        
                    if (error) throw error;
                } else {
                    // æ’å…¥æ–°è®°å½•
                    const { data, error } = await supabaseClient
                        .from(currentConfig.tableName)
                        .insert(rowData)
                        .select();
                        
                    if (error) throw error;
                    
                    // ä¿å­˜è¿”å›çš„ID
                    if (data && data[0]) {
                        tr.dataset.id = data[0].id;
                    }
                }
                successCount++;
            } catch (err) {
                console.error('åŒæ­¥å•æ¡è®°å½•å¤±è´¥:', err);
                errorCount++;
            }
        }
        
        // æ›´æ–°æœ¬åœ°å­˜å‚¨ä¸­çš„ID
        saveLocalData();
        
        if (errorCount > 0) {
            showStatus(`åŒæ­¥å®Œæˆï¼š${successCount}æ¡æˆåŠŸï¼Œ${errorCount}æ¡å¤±è´¥`, 'error');
        } else {
            showStatus(`âœ… åŒæ­¥å®Œæˆï¼š${successCount}æ¡è®°å½•å·²ä¿å­˜åˆ°äº‘ç«¯`, 'success');
        }
    } catch (error) {
        showStatus('åŒæ­¥å¤±è´¥ï¼š' + error.message, 'error');
    }
}

/* ========= ç»Ÿè®¡è®¡ç®— ========= */
function calc() {
    let total = 0;
    const map = {};
    [...tbody.children].forEach(tr => {
        const amt = parseFloat(tr.querySelector(".amount-input")?.value) || 0;
        const type = tr.querySelector(".category-select")?.value || '';
        total += amt;
        if (type) {
            map[type] = (map[type] || 0) + amt;
        }
    });
    
    document.getElementById("total").textContent = total.toFixed(2);
    
    const detail = Object.entries(map)
        .map(([k, v]) => `${k}: Â¥${v.toFixed(2)}`)
        .join("<br>");
    document.getElementById("detail").innerHTML = detail || 'æš‚æ— åˆ†ç±»ç»Ÿè®¡';
}

/* ========= äº‹ä»¶ç»‘å®š ========= */
document.addEventListener('DOMContentLoaded', init);

document.getElementById("addRow").onclick = () => {
    addRow();
    saveLocalData();
};

yearEl.onchange = monthEl.onchange = () => {
    loadCurrentMonth();
};

/* ========= Excelå¯¼å‡º ========= */
document.getElementById("export").onclick = () => {
    const data = [["æ—¥æœŸ", "ç±»å‹", "é‡‘é¢", "å¤‡æ³¨"]];
    [...tbody.children].forEach(tr => {
        const inputs = tr.querySelectorAll("input,select");
        data.push([
            inputs[0].value,
            inputs[1].value,
            inputs[2].value,
            inputs[3].value
        ]);
    });
    
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(data), "æœˆåº¦èŠ±é”€");
    const fileName = `${yearEl.value}å¹´${parseInt(monthEl.value) + 1}æœˆèŠ±é”€.xlsx`;
    XLSX.writeFile(wb, fileName);
    showStatus(`Excelæ–‡ä»¶"${fileName}"å¯¼å‡ºæˆåŠŸï¼`, 'success');
};
</script>
</body>
</html>
