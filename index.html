<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æœˆåº¦èŠ±é”€è®°è´¦è¡¨ - è‡ªå®šä¹‰ç±»å‹</title>
<style>
* { box-sizing: border-box; margin:0; padding:0; }
body { font-family:'Segoe UI', Tahoma, Geneva, Verdana,sans-serif; background:#f5f7fa; padding:20px; }
.container { max-width:1200px; margin:0 auto; background:white; border-radius:12px; padding:20px; box-shadow:0 5px 15px rgba(0,0,0,0.1);}
header { text-align:center; margin-bottom:20px;}
h1 { font-size:2rem; margin-bottom:5px;}
.controls { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:10px; }
button { padding:8px 12px; border:none; border-radius:6px; cursor:pointer; background:#3498db; color:white; }
button:hover { background:#2980b9; }
.delete-btn { background:#e74c3c; }
.delete-btn:hover { background:#c0392b; }
.export-btn { background:#27ae60; }
.export-btn:hover { background:#219653; }
.table-container { overflow-x:auto; margin-bottom:20px; }
table { width:100%; border-collapse:collapse; min-width:600px; }
th, td { padding:10px; border-bottom:1px solid #ddd; text-align:left; }
.type-water { background:rgba(52,152,219,0.1);}
.type-food { background:rgba(46,204,113,0.1);}
.type-transport { background:rgba(155,89,182,0.1);}
.type-custom { background:rgba(241,196,15,0.1);}
.summary { background:#f8f9fa; padding:15px; border-radius:8px; }
.summary-item { background:white; padding:10px; border-radius:6px; margin-bottom:10px;}
.summary-item.total { background:#3498db; color:white; font-weight:bold; }
.notification { position:fixed; top:20px; right:20px; background:#27ae60; color:white; padding:10px 15px; border-radius:4px; transform:translateX(100%); transition:transform 0.3s ease; z-index:1000;}
.notification.show { transform:translateX(0);}
.notification.error { background:#e74c3c;}
#custom-types-list { display:flex; flex-wrap:wrap; gap:5px; margin-top:5px; }

/* æ‰‹æœºé€‚é… */
@media (max-width: 768px) {
    /* ä¿æŒåŸæœ‰çš„æ§åˆ¶å’Œè¾“å…¥æ¡†é€‚é… */
    .controls { flex-direction:column; align-items:stretch; }
    .month-year-select { display:flex; gap:10px; margin-bottom:10px; }
    .month-year-select select { flex:1; }
    .controls button { width:100%; }
    .custom-type-section input, .custom-type-section button { width:100%; margin-bottom:5px; }
    
    /* æ ¸å¿ƒè¡¨æ ¼ä¼˜åŒ–ï¼šå“åº”å¼å †å å¸ƒå±€ */
    .table-container { 
        overflow-x: hidden; /* åœ¨å°å±å¹•ä¸Šå–æ¶ˆæ°´å¹³æ»šåŠ¨ */
    }
    table {
        min-width: unset; /* å–æ¶ˆè¡¨æ ¼çš„æœ€å°å®½åº¦é™åˆ¶ */
    }
    table, thead, tbody, th, td, tr {
        display: block; /* æ‰€æœ‰è¡¨æ ¼å…ƒç´ éƒ½å˜ä¸ºå—çº§å…ƒç´  */
    }

    /* éšè—è¡¨å¤´ */
    thead tr {
        position: absolute;
        top: -9999px;
        left: -9999px;
    }

    /* ä¼˜åŒ–è¡¨æ ¼è¡Œ (æ¯æ¡è®°å½•) */
    tr {
        border: 1px solid #ccc; /* ç»™æ¯æ¡è®°å½•åŠ è¾¹æ¡†ï¼Œä½¿å…¶æ›´åƒä¸€ä¸ªå¡ç‰‡ */
        margin-bottom: 10px;
        border-radius: 8px;
        overflow: hidden; 
        padding: 0; /* æ¸…é™¤é»˜è®¤å†…è¾¹è· */
    }

    /* ä¼˜åŒ–è¡¨æ ¼å•å…ƒæ ¼ (æ¯æ¡è®°å½•ä¸­çš„å­—æ®µ) */
    td {
        border: none;
        border-bottom: 1px solid #eee; /* ç”¨ç»†çº¿åˆ†éš”å­—æ®µ */
        position: relative;
        padding-left: 50%; /* ç•™å‡ºç©ºé—´ç»™ä¼ªå…ƒç´ æ ‡é¢˜ */
        text-align: right;
        min-height: 40px; /* ç¡®ä¿æœ‰è¶³å¤Ÿçš„ç©ºé—´ */
    }
    
    /* ç¡®ä¿è¾“å…¥æ¡†å’Œé€‰æ‹©æ¡†åœ¨å³ä¾§å±…ä¸­å¯¹é½ */
    td input, td select {
        width: 100%;
        text-align: right;
        border: none;
        padding: 0;
        margin: 0;
        line-height: 1.2;
        background: transparent; /* ä¿æŒè¾“å…¥æ¡†èƒŒæ™¯é€æ˜ï¼Œä½¿å…¶çœ‹èµ·æ¥æ˜¯å•å…ƒæ ¼çš„ä¸€éƒ¨åˆ† */
    }

    /* ä½¿ç”¨ä¼ªå…ƒç´ æ˜¾ç¤ºæ ‡é¢˜ (æ•°æ®æ ‡ç­¾) */
    td::before {
        content: attr(data-label); /* è·å–è‡ªå®šä¹‰çš„data-labelå±æ€§ä½œä¸ºæ ‡é¢˜ */
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        width: 40%;
        padding-right: 10px;
        white-space: nowrap;
        text-align: left;
        font-weight: bold;
        color: #555;
    }
    
    /* çªå‡ºæ“ä½œæŒ‰é’® */
    td:last-child {
        text-align: center;
        padding: 10px;
        border-bottom: none;
    }
    td:last-child button {
        width: 50%;
        max-width: 200px;
    }
}
</style>

<!-- ========== æ·»åŠ  Supabase ä»£ç ï¼ˆå¼€å§‹ï¼‰========== -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// === é…ç½®éƒ¨åˆ† ===
const SUPABASE_URL = 'https://lhmegseratwrdomkuikk.supabase.co';  // ğŸ”„ è¿™é‡Œå¡«ä½ çš„ URL
const SUPABASE_KEY = 'sb_publishable_vG66XSCR6tYWuQD3-8Ta6Q_MP_cw39B';      // ğŸ”„ è¿™é‡Œå¡«ä½ çš„ KEY

// åˆ›å»ºå®¢æˆ·ç«¯
let supabaseClient = null;

// åˆå§‹åŒ– Supabase
async function initSupabase() {
    if (!SUPABASE_URL.includes('ä½ çš„é¡¹ç›®') && !SUPABASE_KEY.includes('eyJhbGci')) {
        const { createClient } = supabase;
        supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // å°è¯•è‡ªåŠ¨ç™»å½•ï¼ˆåŒ¿åç”¨æˆ·ï¼‰
        try {
            const { data, error } = await supabaseClient.auth.signInAnonymously();
            if (error) {
                console.warn('åŒ¿åç™»å½•å¤±è´¥ï¼Œå°†ç»§ç»­ä½¿ç”¨æœ¬åœ°å­˜å‚¨:', error.message);
            } else {
                console.log('âœ… Supabase åˆå§‹åŒ–æˆåŠŸï¼Œç”¨æˆ·ID:', data.user?.id);
            }
        } catch (e) {
            console.warn('Supabase è¿æ¥å¤±è´¥ï¼Œå°†ä½¿ç”¨æœ¬åœ°å­˜å‚¨:', e.message);
        }
    }
}

// ä¿å­˜æ•°æ®åˆ°äº‘ç«¯ï¼ˆåŒæ—¶ä¿æŒæœ¬åœ°å­˜å‚¨ï¼‰
async function saveToCloud(expensesData) {
    if (!supabaseClient) return;
    
    try {
        // è·å–å½“å‰ç”¨æˆ·
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return;
        
        const key = getSelectedYearMonth();
        const monthYear = key; // æ ¼å¼: 2024-01
        
        // ä¿å­˜åˆ°äº‘ç«¯
        const { error } = await supabaseClient
            .from('expenses')
            .upsert({
                user_id: user.id,
                month_year: monthYear,
                data: expensesData,
                updated_at: new Date().toISOString()
            }, {
                onConflict: 'user_id,month_year'
            });
        
        if (error) throw error;
        console.log('âœ… æ•°æ®å·²ä¿å­˜åˆ°äº‘ç«¯');
    } catch (error) {
        console.warn('äº‘ç«¯ä¿å­˜å¤±è´¥:', error.message);
    }
}

// ä»äº‘ç«¯åŠ è½½æ•°æ®
async function loadFromCloud() {
    if (!supabaseClient) return null;
    
    try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return null;
        
        const key = getSelectedYearMonth();
        const monthYear = key;
        
        const { data, error } = await supabaseClient
            .from('expenses')
            .select('data')
            .eq('user_id', user.id)
            .eq('month_year', monthYear)
            .single();
        
        if (error) throw error;
        return data?.data || null;
    } catch (error) {
        console.warn('äº‘ç«¯åŠ è½½å¤±è´¥:', error.message);
        return null;
    }
}

// ä¿®æ”¹ç°æœ‰çš„ saveExpenseData å‡½æ•°ï¼Œæ·»åŠ äº‘åŒæ­¥
const originalSaveExpenseData = window.saveExpenseData;
window.saveExpenseData = function() {
    // è°ƒç”¨åŸå§‹å‡½æ•°ä¿å­˜åˆ°æœ¬åœ°
    if (originalSaveExpenseData) originalSaveExpenseData();
    
    // è·å–å½“å‰æ•°æ®
    const rows = document.querySelectorAll('#expense-table tbody tr');
    const data = Array.from(rows).map(r => ({
        id: r.dataset.id,
        date: r.querySelector('.date-input').value,
        type: r.querySelector('.type-select').value,
        amount: parseFloat(r.querySelector('.amount-input').value) || 0,
        notes: r.querySelector('.notes-input').value
    }));
    
    // ä¿å­˜åˆ°äº‘ç«¯
    saveToCloud(data);
};

// ä¿®æ”¹ç°æœ‰çš„ loadExpenseData å‡½æ•°ï¼Œä¼˜å…ˆä»äº‘ç«¯åŠ è½½
const originalLoadExpenseData = window.loadExpenseData;
window.loadExpenseData = async function() {
    // 1. å…ˆå°è¯•ä»äº‘ç«¯åŠ è½½
    const cloudData = await loadFromCloud();
    
    if (cloudData && cloudData.length > 0) {
        // æ¸…ç©ºè¡¨æ ¼
        const tbody = document.querySelector('#expense-table tbody');
        tbody.innerHTML = '';
        
        // åŠ è½½äº‘ç«¯æ•°æ®
        cloudData.forEach(d => addRowToTable(d.date, d.type, d.amount, d.notes, d.id));
        calculateSummary();
        showNotification('å·²ä»äº‘ç«¯åŠ è½½æ•°æ®');
    } else {
        // 2. å¦‚æœäº‘ç«¯æ²¡æœ‰æ•°æ®ï¼Œä»æœ¬åœ°åŠ è½½
        if (originalLoadExpenseData) originalLoadExpenseData();
        console.log('ä½¿ç”¨æœ¬åœ°å­˜å‚¨æ•°æ®');
    }
};

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', async function() {
    // å»¶è¿Ÿåˆå§‹åŒ–ï¼Œç­‰å¾…é¡µé¢åŠ è½½å®Œæˆ
    setTimeout(async () => {
        await initSupabase();
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨ä»äº‘ç«¯åŒæ­¥
        setTimeout(async () => {
            await loadFromCloud();
        }, 1000);
    }, 500);
});
</script>
<!-- ========== æ·»åŠ  Supabase ä»£ç ï¼ˆç»“æŸï¼‰========== -->

</head>

<body>
<div class="container">
    <header>
        <h1>æœˆåº¦èŠ±é”€è®°è´¦è¡¨</h1>
    </header>

    <div class="controls">
        <div class="month-year-select">
            <select id="month-select"></select>
            <select id="year-select"></select>
        </div>
        <div>
            <button id="add-row">+ æ·»åŠ è®°å½•</button>
            <button id="export-xlsx" class="export-btn">å¯¼å‡º Excel</button>
        </div>
    </div>

    <div class="custom-type-section">
        <input type="text" id="new-type-input" placeholder="è¾“å…¥æ–°çš„èŠ±é”€ç±»å‹">
        <button id="add-type">æ·»åŠ ç±»å‹</button>
        <div id="custom-types-list"></div>
    </div>

    <div class="table-container">
        <table id="expense-table">
            <thead>
                <tr>
                    <th>æ—¥æœŸ</th>
                    <th>ç±»å‹</th>
                    <th>é‡‘é¢</th>
                    <th>å¤‡æ³¨</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="summary" id="summary-grid">
        <div class="summary-item total">
            æ€»èŠ±é”€: Â¥<span id="total-expense">0</span>
        </div>
    </div>
</div>

<div class="notification" id="notification"></div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const expenseTypes = ['æ°´','é£Ÿç‰©','å‡ºè¡Œ'];
    let customTypes = [];

    const monthSelect = document.getElementById('month-select');
    const yearSelect = document.getElementById('year-select');

    // åˆå§‹åŒ–æœˆä»½
    ['ä¸€æœˆ','äºŒæœˆ','ä¸‰æœˆ','å››æœˆ','äº”æœˆ','å…­æœˆ','ä¸ƒæœˆ','å…«æœˆ','ä¹æœˆ','åæœˆ','åä¸€æœˆ','åäºŒæœˆ'].forEach((m,i)=>{
        const opt = document.createElement('option'); opt.value=i; opt.textContent=m; monthSelect.appendChild(opt);
    });
    monthSelect.value = new Date().getMonth();

    // åˆå§‹åŒ–å¹´ä»½
    const currentYear = new Date().getFullYear();
    for(let y=currentYear-5;y<=currentYear+1;y++){
        const opt = document.createElement('option'); opt.value=y; opt.textContent=y; if(y===currentYear) opt.selected=true; yearSelect.appendChild(opt);
    }

    loadCustomTypes();
    loadExpenseData();
    calculateSummary();

    document.getElementById('add-row').addEventListener('click', addNewRow);
    document.getElementById('add-type').addEventListener('click', addCustomType);
    monthSelect.addEventListener('change', loadExpenseData);
    yearSelect.addEventListener('change', loadExpenseData);
    document.getElementById('export-xlsx').addEventListener('click', generateXLSX);

    function showNotification(msg, isError=false){
        const n=document.getElementById('notification'); n.textContent=msg; n.classList.remove('error'); if(isError) n.classList.add('error'); n.classList.add('show');
        setTimeout(()=>n.classList.remove('show'),3000);
    }

    function getSelectedYearMonth(){ 
        const month=(parseInt(monthSelect.value)+1).toString().padStart(2,'0'); 
        return `${yearSelect.value}-${month}`; 
    }
    function getSelectedYearMonthText(){ 
        const monthNames=['ä¸€æœˆ','äºŒæœˆ','ä¸‰æœˆ','å››æœˆ','äº”æœˆ','å…­æœˆ','ä¸ƒæœˆ','å…«æœˆ','ä¹æœˆ','åæœˆ','åä¸€æœˆ','åäºŒæœˆ'];
        return `${yearSelect.value}å¹´${monthNames[parseInt(monthSelect.value)]}`;
    }

    function loadCustomTypes(){
        const saved = localStorage.getItem('customExpenseTypes');
        if(saved) customTypes = JSON.parse(saved);
        updateCustomTypesDisplay();
    }
    function saveCustomTypes(){ localStorage.setItem('customExpenseTypes', JSON.stringify(customTypes)); }
    function updateCustomTypesDisplay(){
        const list=document.getElementById('custom-types-list'); list.innerHTML='';
        customTypes.forEach(type=>{
            const tag=document.createElement('div'); tag.style.display='inline-block'; tag.style.marginRight='5px';
            tag.style.background='#3498db'; tag.style.color='white'; tag.style.padding='3px 8px'; tag.style.borderRadius='10px';
            tag.innerHTML=`${type} <span style="cursor:pointer;" data-type="${type}">Ã—</span>`;
            list.appendChild(tag);
        });
        document.querySelectorAll('#custom-types-list span').forEach(sp=>sp.addEventListener('click',()=>{ removeCustomType(sp.dataset.type); }));
    }
    function addCustomType(){
        const input=document.getElementById('new-type-input'); const t=input.value.trim(); if(!t){showNotification('è¯·è¾“å…¥ç±»å‹',true); return;}
        if(expenseTypes.includes(t) || customTypes.includes(t)){showNotification('ç±»å‹å·²å­˜åœ¨',true); return;}
        customTypes.push(t); saveCustomTypes(); updateCustomTypesDisplay(); input.value=''; showNotification(`ç±»å‹ "${t}" æ·»åŠ æˆåŠŸ`);
        updateTypeSelects();
    }
    function removeCustomType(t){ customTypes=customTypes.filter(x=>x!==t); saveCustomTypes(); updateCustomTypesDisplay(); loadExpenseData(); showNotification(`ç±»å‹ "${t}" å·²åˆ é™¤`); }

    function addNewRow(){
        const today=new Date();
        const date=`${today.getFullYear()}-${(today.getMonth()+1).toString().padStart(2,'0')}-${today.getDate().toString().padStart(2,'0')}`;
        // æ–°è®°å½•é»˜è®¤ç±»å‹è®¾ä¸ºâ€œé£Ÿç‰©â€
        addRowToTable(date,'é£Ÿç‰©','', '', Date.now()); 
    }

    function addRowToTable(date,type,amount,notes,id){
        const tbody=document.querySelector('#expense-table tbody'); 
        const row=document.createElement('tr'); row.dataset.id=id;
        const typeClass=getTypeClass(type); row.className=`type-${typeClass}`;
        
        // **ã€ä¿®æ”¹ç‚¹ã€‘**ï¼šä¸ºæ¯ä¸ª <td> æ·»åŠ  data-label å±æ€§ï¼Œç”¨äºæ‰‹æœºç«¯æ˜¾ç¤ºæ ‡ç­¾
        row.innerHTML=`
            <td data-label="æ—¥æœŸ"><input type="date" value="${date}" class="date-input"></td>
            <td data-label="ç±»å‹"><select class="type-select"></select></td>
            <td data-label="é‡‘é¢"><input type="number" value="${amount}" class="amount-input" min="0" step="0.01"></td>
            <td data-label="å¤‡æ³¨"><input type="text" value="${notes}" class="notes-input"></td>
            <td data-label="æ“ä½œ"><button class="delete-btn">åˆ é™¤</button></td>
        `;
        // **ã€ä¿®æ”¹ç‚¹ç»“æŸã€‘**

        const select=row.querySelector('.type-select'); updateSingleTypeSelect(select,type);
        row.querySelectorAll('input, select').forEach(el=>el.addEventListener('input', saveExpenseData));
        row.querySelector('.delete-btn').addEventListener('click',()=>{ row.remove(); saveExpenseData(); });
        tbody.appendChild(row);
        saveExpenseData();
    }

    function updateSingleTypeSelect(select,val){
        const all=[...expenseTypes,...customTypes]; select.innerHTML=''; all.forEach(t=>{ const opt=document.createElement('option'); opt.value=t; opt.textContent=t; if(t===val) opt.selected=true; select.appendChild(opt); });
        select.addEventListener('change', saveExpenseData);
    }

    function updateTypeSelects(){
        document.querySelectorAll('.type-select').forEach(s=>{ const val=s.value; updateSingleTypeSelect(s,val); });
    }

    function getTypeClass(t){ if(t==='æ°´') return 'water'; if(t==='é£Ÿç‰©') return 'food'; if(t==='å‡ºè¡Œ') return 'transport'; return 'custom'; }

    function saveExpenseData(){
        const rows=document.querySelectorAll('#expense-table tbody tr');
        const data=Array.from(rows).map(r=>({
            id:r.dataset.id, date:r.querySelector('.date-input').value,
            type:r.querySelector('.type-select').value,
            amount:parseFloat(r.querySelector('.amount-input').value)||0,
            notes:r.querySelector('.notes-input').value
        }));
        localStorage.setItem(getSelectedYearMonth(),JSON.stringify(data));
        calculateSummary();

        // è°ƒç”¨äº‘ä¿å­˜å‡½æ•°
        if (typeof saveToCloud === 'function') {
            saveToCloud(data);
        }

    }

    function loadExpenseData(){
        const tbody=document.querySelector('#expense-table tbody'); tbody.innerHTML='';
        const key=getSelectedYearMonth();
        const data=JSON.parse(localStorage.getItem(key))||[];
        data.forEach(d=>addRowToTable(d.date,d.type,d.amount,d.notes,d.id));
        calculateSummary();
    }

    function calculateSummary(){
        const rows=document.querySelectorAll('#expense-table tbody tr');
        let total=0; const typeMap={}; [...expenseTypes,...customTypes].forEach(t=>typeMap[t]={amount:0,count:0});
        rows.forEach(r=>{ const amt=parseFloat(r.querySelector('.amount-input').value)||0; const t=r.querySelector('.type-select').value; total+=amt; if(!typeMap[t]) typeMap[t]={amount:0,count:0}; typeMap[t].amount+=amt; typeMap[t].count+=1; });
        const grid=document.getElementById('summary-grid'); const totalDiv=grid.querySelector('.total'); grid.innerHTML=''; grid.appendChild(totalDiv); document.getElementById('total-expense').textContent=total.toFixed(2);
        Object.keys(typeMap).forEach(t=>{ const d=typeMap[t]; if(d.count>0){ const div=document.createElement('div'); div.className='summary-item'; div.innerHTML=`${t}: Â¥${d.amount.toFixed(2)} (æ¬¡æ•°:${d.count})`; grid.appendChild(div); }});
    }

    function generateXLSX(){
        try{
            const monthYear=getSelectedYearMonthText();
            const rows=document.querySelectorAll('#expense-table tbody tr');
            const data=[["æ—¥æœŸ","ç±»å‹","é‡‘é¢","å¤‡æ³¨"]];
            rows.forEach(r=>{ data.push([r.querySelector('.date-input').value,r.querySelector('.type-select').value,r.querySelector('.amount-input').value,r.querySelector('.notes-input').value]); });
            const wb=XLSX.utils.book_new(); const ws=XLSX.utils.aoa_to_sheet(data);
            ws['!cols']=[{wch:15},{wch:15},{wch:12},{wch:40}];
            XLSX.utils.book_append_sheet(wb,ws,"èŠ±é”€è®°å½•"); XLSX.writeFile(wb,`${monthYear}èŠ±é”€è®°å½•.xlsx`);
            showNotification("Excel å¯¼å‡ºæˆåŠŸï¼");
        }catch(e){ console.error(e); showNotification("Excel å¯¼å‡ºå¤±è´¥",true); }
    }
});
</script>
</body>
</html>


