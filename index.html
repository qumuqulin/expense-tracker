<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>月度花销记账表 - 自定义类型</title>
<style>
* { box-sizing: border-box; margin:0; padding:0; }
body { font-family:'Segoe UI', Tahoma, Geneva, Verdana,sans-serif; background:#f5f7fa; padding:20px; }
.container { max-width:1200px; margin:0 auto; background:white; border-radius:12px; padding:20px; box-shadow:0 5px 15px rgba(0,0,0,0.1);}
header { text-align:center; margin-bottom:20px;}
h1 { font-size:2rem; margin-bottom:5px;}
.controls { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:10px; }
button { padding:8px 12px; border:none; border-radius:6px; cursor:pointer; background:#3498db; color:white; }
button:hover { background:#2980b9; }
.delete-btn { background:#e74c3c; }
.delete-btn:hover { background:#c0392b; }
.export-btn { background:#27ae60; }
.export-btn:hover { background:#219653; }
.table-container { overflow-x:auto; margin-bottom:20px; }
table { width:100%; border-collapse:collapse; min-width:600px; }
th, td { padding:10px; border-bottom:1px solid #ddd; text-align:left; }
.type-water { background:rgba(52,152,219,0.1);}
.type-food { background:rgba(46,204,113,0.1);}
.type-transport { background:rgba(155,89,182,0.1);}
.type-custom { background:rgba(241,196,15,0.1);}
.summary { background:#f8f9fa; padding:15px; border-radius:8px; }
.summary-item { background:white; padding:10px; border-radius:6px; margin-bottom:10px;}
.summary-item.total { background:#3498db; color:white; font-weight:bold; }
.notification { position:fixed; top:20px; right:20px; background:#27ae60; color:white; padding:10px 15px; border-radius:4px; transform:translateX(100%); transition:transform 0.3s ease; z-index:1000;}
.notification.show { transform:translateX(0);}
.notification.error { background:#e74c3c;}
#custom-types-list { display:flex; flex-wrap:wrap; gap:5px; margin-top:5px; }

/* 手机适配 */
@media (max-width: 768px) {
    /* 保持原有的控制和输入框适配 */
    .controls { flex-direction:column; align-items:stretch; }
    .month-year-select { display:flex; gap:10px; margin-bottom:10px; }
    .month-year-select select { flex:1; }
    .controls button { width:100%; }
    .custom-type-section input, .custom-type-section button { width:100%; margin-bottom:5px; }
    
    /* 核心表格优化：响应式堆叠布局 */
    .table-container { 
        overflow-x: hidden; /* 在小屏幕上取消水平滚动 */
    }
    table {
        min-width: unset; /* 取消表格的最小宽度限制 */
    }
    table, thead, tbody, th, td, tr {
        display: block; /* 所有表格元素都变为块级元素 */
    }

    /* 隐藏表头 */
    thead tr {
        position: absolute;
        top: -9999px;
        left: -9999px;
    }

    /* 优化表格行 (每条记录) */
    tr {
        border: 1px solid #ccc; /* 给每条记录加边框，使其更像一个卡片 */
        margin-bottom: 10px;
        border-radius: 8px;
        overflow: hidden; 
        padding: 0; /* 清除默认内边距 */
    }

    /* 优化表格单元格 (每条记录中的字段) */
    td {
        border: none;
        border-bottom: 1px solid #eee; /* 用细线分隔字段 */
        position: relative;
        padding-left: 50%; /* 留出空间给伪元素标题 */
        text-align: right;
        min-height: 40px; /* 确保有足够的空间 */
    }
    
    /* 确保输入框和选择框在右侧居中对齐 */
    td input, td select {
        width: 100%;
        text-align: right;
        border: none;
        padding: 0;
        margin: 0;
        line-height: 1.2;
        background: transparent; /* 保持输入框背景透明，使其看起来是单元格的一部分 */
    }

    /* 使用伪元素显示标题 (数据标签) */
    td::before {
        content: attr(data-label); /* 获取自定义的data-label属性作为标题 */
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        width: 40%;
        padding-right: 10px;
        white-space: nowrap;
        text-align: left;
        font-weight: bold;
        color: #555;
    }
    
    /* 突出操作按钮 */
    td:last-child {
        text-align: center;
        padding: 10px;
        border-bottom: none;
    }
    td:last-child button {
        width: 50%;
        max-width: 200px;
    }
}
</style>
</head>
<body>
<div class="container">
    <header>
        <h1>月度花销记账表</h1>
    </header>

    <div class="controls">
        <div class="month-year-select">
            <select id="month-select"></select>
            <select id="year-select"></select>
        </div>
        <div>
            <button id="add-row">+ 添加记录</button>
            <button id="export-xlsx" class="export-btn">导出 Excel</button>
        </div>
    </div>

    <div class="custom-type-section">
        <input type="text" id="new-type-input" placeholder="输入新的花销类型">
        <button id="add-type">添加类型</button>
        <div id="custom-types-list"></div>
    </div>

    <div class="table-container">
        <table id="expense-table">
            <thead>
                <tr>
                    <th>日期</th>
                    <th>类型</th>
                    <th>金额</th>
                    <th>备注</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="summary" id="summary-grid">
        <div class="summary-item total">
            总花销: ¥<span id="total-expense">0</span>
        </div>
    </div>
</div>

<div class="notification" id="notification"></div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const expenseTypes = ['水','食物','出行'];
    let customTypes = [];

    const monthSelect = document.getElementById('month-select');
    const yearSelect = document.getElementById('year-select');

    // 初始化月份
    ['一月','二月','三月','四月','五月','六月','七月','八月','九月','十月','十一月','十二月'].forEach((m,i)=>{
        const opt = document.createElement('option'); opt.value=i; opt.textContent=m; monthSelect.appendChild(opt);
    });
    monthSelect.value = new Date().getMonth();

    // 初始化年份
    const currentYear = new Date().getFullYear();
    for(let y=currentYear-5;y<=currentYear+1;y++){
        const opt = document.createElement('option'); opt.value=y; opt.textContent=y; if(y===currentYear) opt.selected=true; yearSelect.appendChild(opt);
    }

    loadCustomTypes();
    loadExpenseData();
    calculateSummary();

    document.getElementById('add-row').addEventListener('click', addNewRow);
    document.getElementById('add-type').addEventListener('click', addCustomType);
    monthSelect.addEventListener('change', loadExpenseData);
    yearSelect.addEventListener('change', loadExpenseData);
    document.getElementById('export-xlsx').addEventListener('click', generateXLSX);

    function showNotification(msg, isError=false){
        const n=document.getElementById('notification'); n.textContent=msg; n.classList.remove('error'); if(isError) n.classList.add('error'); n.classList.add('show');
        setTimeout(()=>n.classList.remove('show'),3000);
    }

    function getSelectedYearMonth(){ 
        const month=(parseInt(monthSelect.value)+1).toString().padStart(2,'0'); 
        return `${yearSelect.value}-${month}`; 
    }
    function getSelectedYearMonthText(){ 
        const monthNames=['一月','二月','三月','四月','五月','六月','七月','八月','九月','十月','十一月','十二月'];
        return `${yearSelect.value}年${monthNames[parseInt(monthSelect.value)]}`;
    }

    function loadCustomTypes(){
        const saved = localStorage.getItem('customExpenseTypes');
        if(saved) customTypes = JSON.parse(saved);
        updateCustomTypesDisplay();
    }
    function saveCustomTypes(){ localStorage.setItem('customExpenseTypes', JSON.stringify(customTypes)); }
    function updateCustomTypesDisplay(){
        const list=document.getElementById('custom-types-list'); list.innerHTML='';
        customTypes.forEach(type=>{
            const tag=document.createElement('div'); tag.style.display='inline-block'; tag.style.marginRight='5px';
            tag.style.background='#3498db'; tag.style.color='white'; tag.style.padding='3px 8px'; tag.style.borderRadius='10px';
            tag.innerHTML=`${type} <span style="cursor:pointer;" data-type="${type}">×</span>`;
            list.appendChild(tag);
        });
        document.querySelectorAll('#custom-types-list span').forEach(sp=>sp.addEventListener('click',()=>{ removeCustomType(sp.dataset.type); }));
    }
    function addCustomType(){
        const input=document.getElementById('new-type-input'); const t=input.value.trim(); if(!t){showNotification('请输入类型',true); return;}
        if(expenseTypes.includes(t) || customTypes.includes(t)){showNotification('类型已存在',true); return;}
        customTypes.push(t); saveCustomTypes(); updateCustomTypesDisplay(); input.value=''; showNotification(`类型 "${t}" 添加成功`);
        updateTypeSelects();
    }
    function removeCustomType(t){ customTypes=customTypes.filter(x=>x!==t); saveCustomTypes(); updateCustomTypesDisplay(); loadExpenseData(); showNotification(`类型 "${t}" 已删除`); }

    function addNewRow(){
        const today=new Date();
        const date=`${today.getFullYear()}-${(today.getMonth()+1).toString().padStart(2,'0')}-${today.getDate().toString().padStart(2,'0')}`;
        // 新记录默认类型设为“食物”
        addRowToTable(date,'食物','', '', Date.now()); 
    }

    function addRowToTable(date,type,amount,notes,id){
        const tbody=document.querySelector('#expense-table tbody'); 
        const row=document.createElement('tr'); row.dataset.id=id;
        const typeClass=getTypeClass(type); row.className=`type-${typeClass}`;
        
        // **【修改点】**：为每个 <td> 添加 data-label 属性，用于手机端显示标签
        row.innerHTML=`
            <td data-label="日期"><input type="date" value="${date}" class="date-input"></td>
            <td data-label="类型"><select class="type-select"></select></td>
            <td data-label="金额"><input type="number" value="${amount}" class="amount-input" min="0" step="0.01"></td>
            <td data-label="备注"><input type="text" value="${notes}" class="notes-input"></td>
            <td data-label="操作"><button class="delete-btn">删除</button></td>
        `;
        // **【修改点结束】**

        const select=row.querySelector('.type-select'); updateSingleTypeSelect(select,type);
        row.querySelectorAll('input, select').forEach(el=>el.addEventListener('input', saveExpenseData));
        row.querySelector('.delete-btn').addEventListener('click',()=>{ row.remove(); saveExpenseData(); });
        tbody.appendChild(row);
        saveExpenseData();
    }

    function updateSingleTypeSelect(select,val){
        const all=[...expenseTypes,...customTypes]; select.innerHTML=''; all.forEach(t=>{ const opt=document.createElement('option'); opt.value=t; opt.textContent=t; if(t===val) opt.selected=true; select.appendChild(opt); });
        select.addEventListener('change', saveExpenseData);
    }

    function updateTypeSelects(){
        document.querySelectorAll('.type-select').forEach(s=>{ const val=s.value; updateSingleTypeSelect(s,val); });
    }

    function getTypeClass(t){ if(t==='水') return 'water'; if(t==='食物') return 'food'; if(t==='出行') return 'transport'; return 'custom'; }

    function saveExpenseData(){
        const rows=document.querySelectorAll('#expense-table tbody tr');
        const data=Array.from(rows).map(r=>({
            id:r.dataset.id, date:r.querySelector('.date-input').value,
            type:r.querySelector('.type-select').value,
            amount:parseFloat(r.querySelector('.amount-input').value)||0,
            notes:r.querySelector('.notes-input').value
        }));
        localStorage.setItem(getSelectedYearMonth(),JSON.stringify(data));
        calculateSummary();
    }

    function loadExpenseData(){
        const tbody=document.querySelector('#expense-table tbody'); tbody.innerHTML='';
        const key=getSelectedYearMonth();
        const data=JSON.parse(localStorage.getItem(key))||[];
        data.forEach(d=>addRowToTable(d.date,d.type,d.amount,d.notes,d.id));
        calculateSummary();
    }

    function calculateSummary(){
        const rows=document.querySelectorAll('#expense-table tbody tr');
        let total=0; const typeMap={}; [...expenseTypes,...customTypes].forEach(t=>typeMap[t]={amount:0,count:0});
        rows.forEach(r=>{ const amt=parseFloat(r.querySelector('.amount-input').value)||0; const t=r.querySelector('.type-select').value; total+=amt; if(!typeMap[t]) typeMap[t]={amount:0,count:0}; typeMap[t].amount+=amt; typeMap[t].count+=1; });
        const grid=document.getElementById('summary-grid'); const totalDiv=grid.querySelector('.total'); grid.innerHTML=''; grid.appendChild(totalDiv); document.getElementById('total-expense').textContent=total.toFixed(2);
        Object.keys(typeMap).forEach(t=>{ const d=typeMap[t]; if(d.count>0){ const div=document.createElement('div'); div.className='summary-item'; div.innerHTML=`${t}: ¥${d.amount.toFixed(2)} (次数:${d.count})`; grid.appendChild(div); }});
    }

    function generateXLSX(){
        try{
            const monthYear=getSelectedYearMonthText();
            const rows=document.querySelectorAll('#expense-table tbody tr');
            const data=[["日期","类型","金额","备注"]];
            rows.forEach(r=>{ data.push([r.querySelector('.date-input').value,r.querySelector('.type-select').value,r.querySelector('.amount-input').value,r.querySelector('.notes-input').value]); });
            const wb=XLSX.utils.book_new(); const ws=XLSX.utils.aoa_to_sheet(data);
            ws['!cols']=[{wch:15},{wch:15},{wch:12},{wch:40}];
            XLSX.utils.book_append_sheet(wb,ws,"花销记录"); XLSX.writeFile(wb,`${monthYear}花销记录.xlsx`);
            showNotification("Excel 导出成功！");
        }catch(e){ console.error(e); showNotification("Excel 导出失败",true); }
    }
});
</script>
</body>
</html>
