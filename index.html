<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>月度花销记账表</title>

<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif; background:#f5f7fa; padding:20px; }
.container { max-width:1100px; margin:auto; background:#fff; border-radius:12px; padding:20px; box-shadow:0 6px 16px rgba(0,0,0,.1); }
h1 { text-align:center; margin-bottom:15px; }

.controls { display:flex; justify-content:space-between; flex-wrap:wrap; gap:10px; margin-bottom:15px; }
button { padding:8px 12px; border:none; border-radius:6px; background:#3498db; color:#fff; cursor:pointer; }
button:hover { background:#2980b9; }
.delete-btn { background:#e74c3c; }

table { width:100%; border-collapse:collapse; margin-top:10px; }
th,td { border-bottom:1px solid #ddd; padding:8px; text-align:left; }

.summary { margin-top:15px; background:#f8f9fa; padding:12px; border-radius:8px; }
.summary strong { font-size:18px; }

#auth-box { margin-bottom:20px; padding:15px; border:1px solid #ddd; border-radius:8px; }
#auth-msg { margin-top:8px; font-size:14px; }
</style>

<!-- Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ========= Supabase 初始化（只此一处） ========= */
const SUPABASE_URL = 'https://你的项目.supabase.co';
const SUPABASE_KEY = '你的 publishable / anon key';

const supabase = window.supabase.createClient(
  SUPABASE_URL,
  SUPABASE_KEY
);

let currentUser = null;
</script>
</head>

<body>
<div class="container">
  <h1>月度花销记账表</h1>

  <!-- 登录框 -->
  <div id="auth-box"></div>

  <div class="controls">
    <div>
      <select id="year"></select>
      <select id="month"></select>
    </div>
    <button onclick="addRow()">＋ 添加记录</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>日期</th><th>类型</th><th>金额</th><th>备注</th><th></th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <div class="summary">
    总花销：¥ <strong id="total">0</strong>
  </div>
</div>

<script>
/* ========= 初始化年月 ========= */
const yearSel = document.getElementById('year');
const monthSel = document.getElementById('month');

const now = new Date();
for (let y = now.getFullYear() - 3; y <= now.getFullYear() + 1; y++) {
  yearSel.innerHTML += `<option ${y===now.getFullYear()?'selected':''}>${y}</option>`;
}
['1','2','3','4','5','6','7','8','9','10','11','12']
  .forEach((m,i)=>monthSel.innerHTML+=`<option ${i===now.getMonth()?'selected':''}>${m}</option>`);

/* ========= Auth UI ========= */
const authBox = document.getElementById('auth-box');

function renderAuth() {
  if (currentUser) {
    authBox.innerHTML = `
      已登录：${currentUser.email}
      <button onclick="logout()">退出</button>
    `;
  } else {
    authBox.innerHTML = `
      <input id="email" placeholder="邮箱">
      <input id="pwd" type="password" placeholder="密码">
      <button onclick="login()">登录</button>
      <button onclick="signup()">注册</button>
      <div id="auth-msg"></div>
    `;
  }
}

async function login() {
  const email = email.value, password = pwd.value;
  const { data, error } = await supabase.auth.signInWithPassword({ email, password });
  if (error) return showAuth(error.message);
  currentUser = data.user;
  renderAuth();
  loadCloud();
}

async function signup() {
  const email = email.value, password = pwd.value;
  const { error } = await supabase.auth.signUp({ email, password });
  if (error) return showAuth(error.message);
  showAuth('注册成功，可直接登录');
}

async function logout() {
  await supabase.auth.signOut();
  currentUser = null;
  renderAuth();
}

function showAuth(msg) {
  document.getElementById('auth-msg').textContent = msg;
}

/* ========= 表格逻辑 ========= */
const tbody = document.getElementById('tbody');
function key() { return yearSel.value + '-' + monthSel.value; }

function addRow(data={}) {
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input type="date" value="${data.date||''}"></td>
    <td><input value="${data.type||''}"></td>
    <td><input type="number" value="${data.amount||0}"></td>
    <td><input value="${data.note||''}"></td>
    <td><button class="delete-btn">删</button></td>
  `;
  tr.querySelector('button').onclick=()=>{tr.remove();save()};
  tr.querySelectorAll('input').forEach(i=>i.oninput=save);
  tbody.appendChild(tr);
  save();
}

function save() {
  const rows = [...tbody.children].map(tr=>({
    date:tr.children[0].firstChild.value,
    type:tr.children[1].firstChild.value,
    amount:+tr.children[2].firstChild.value||0,
    note:tr.children[3].firstChild.value
  }));
  localStorage.setItem(key(), JSON.stringify(rows));
  document.getElementById('total').textContent =
    rows.reduce((s,r)=>s+r.amount,0).toFixed(2);

  if (currentUser) saveCloud(rows);
}

function loadLocal() {
  tbody.innerHTML='';
  (JSON.parse(localStorage.getItem(key()))||[]).forEach(addRow);
}

yearSel.onchange = monthSel.onchange = ()=>{ loadLocal(); if(currentUser) loadCloud(); };

/* ========= 云端 ========= */
async function saveCloud(data) {
  await supabase.from('expenses').upsert({
    user_id: currentUser.id,
    month: key(),
    data
  },{onConflict:'user_id,month'});
}

async function loadCloud() {
  const { data } = await supabase
    .from('expenses')
    .select('data')
    .eq('user_id', currentUser.id)
    .eq('month', key())
    .single();
  if (data) {
    tbody.innerHTML='';
    data.data.forEach(addRow);
  }
}

/* ========= 启动 ========= */
(async()=>{
  const { data:{session} } = await supabase.auth.getSession();
  if (session) currentUser = session.user;
  renderAuth();
  loadLocal();
})();
</script>
</body>
</html>
