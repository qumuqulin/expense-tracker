<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>月度花销记账表 - Supabase 版</title>
  <style>
    /* 保留原有样式（略去部分，保持和你之前一样） */
    body { font-family: sans-serif; padding: 20px; background: #f5f7fa; }
    .container { max-width: 1200px; margin: auto; background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    header { background: linear-gradient(90deg, #3498db, #2c3e50); color: white; padding: 20px; text-align: center; }
    h1 { margin: 0; }
    .controls, .summary, .export-section { padding: 20px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid #ddd; padding: 10px; }
    .delete-btn { background: #e74c3c; color: white; border: none; padding: 5px 10px; cursor: pointer; }
  </style>
</head>
<body>
<div class="container">
  <header>
    <h1>月度花销记账表</h1>
    <p>数据存储在 Supabase，支持多设备同步</p>
  </header>

  <div class="controls">
    <select id="month-select">
      <option value="0">一月</option><option value="1">二月</option><option value="2">三月</option>
      <option value="3">四月</option><option value="4">五月</option><option value="5">六月</option>
      <option value="6">七月</option><option value="7">八月</option><option value="8">九月</option>
      <option value="9">十月</option><option value="10">十一月</option><option value="11">十二月</option>
    </select>
    <select id="year-select"></select>
    <button id="add-row">+ 添加记录</button>
  </div>

  <div class="table-container">
    <table id="expense-table">
      <thead>
        <tr>
          <th>日期</th><th>类型</th><th>金额 (元)</th><th>备注</th><th>操作</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="summary">
    <h2>花销统计</h2>
    <p>总花销: ¥<span id="total-expense">0</span></p>
  </div>
</div>

<!-- 引入 Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // 🚨 替换成你自己的 Supabase 项目参数
  const SUPABASE_URL = "https://https://qumuqulin.github.io/expense-tracker/.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVpaGlpc2F2Y2pseGdqaWpyZWNyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwNzkwNjMsImV4cCI6MjA3MzY1NTA2M30.E5IsFrDr65nZoAlnkZN3XR8_QcIx9HSKu3Mc5kZwvI8";
  const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // 初始化年份选择
  const yearSelect = document.getElementById('year-select');
  const currentYear = new Date().getFullYear();
  for (let y = currentYear - 2; y <= currentYear + 1; y++) {
    const opt = document.createElement('option');
    opt.value = y; opt.textContent = y; if (y === currentYear) opt.selected = true;
    yearSelect.appendChild(opt);
  }
  document.getElementById('month-select').value = new Date().getMonth();

  function getSelectedYearMonth() {
    return `${yearSelect.value}-${document.getElementById('month-select').value}`;
  }

  // 加载数据
  async function loadExpenseData() {
    const tbody = document.querySelector('#expense-table tbody');
    tbody.innerHTML = "";
    let { data, error } = await db.from("expenses")
      .select("*")
      .eq("year_month", getSelectedYearMonth())
      .order("date", { ascending: true });
    if (error) { console.error(error); return; }
    data.forEach(exp => addRowToTable(exp.date, exp.type, exp.amount, exp.notes, exp.id));
    calculateSummary();
  }

  // 添加行
  function addRowToTable(date, type, amount, notes, id=null) {
    const tbody = document.querySelector('#expense-table tbody');
    const tr = document.createElement("tr");
    tr.dataset.id = id || "";
    tr.innerHTML = `
      <td><input type="date" value="${date||""}" class="date-input"></td>
      <td>
        <select class="type-select">
          <option value="水" ${type==="水"?"selected":""}>水</option>
          <option value="食物" ${type==="食物"?"selected":""}>食物</option>
          <option value="出行" ${type==="出行"?"selected":""}>出行</option>
          <option value="其它" ${type==="其它"?"selected":""}>其它</option>
        </select>
      </td>
      <td><input type="number" value="${amount||""}" class="amount-input" step="0.01"></td>
      <td><input type="text" value="${notes||""}" class="notes-input"></td>
      <td><button class="delete-btn">删除</button></td>
    `;
    tr.querySelectorAll("input,select").forEach(el=>{
      el.addEventListener("change", ()=>saveExpenseData(tr));
    });
    tr.querySelector(".delete-btn").addEventListener("click", ()=>deleteExpense(tr));
    tbody.appendChild(tr);
  }

  // 保存或更新
  async function saveExpenseData(row) {
    const exp = {
      date: row.querySelector(".date-input").value,
      type: row.querySelector(".type-select").value,
      amount: parseFloat(row.querySelector(".amount-input").value)||0,
      notes: row.querySelector(".notes-input").value,
      year_month: getSelectedYearMonth()
    };
    if (!row.dataset.id) {
      let { data, error } = await db.from("expenses").insert([exp]).select();
      if (!error && data.length>0) row.dataset.id = data[0].id;
    } else {
      await db.from("expenses").update(exp).eq("id", row.dataset.id);
    }
    calculateSummary();
  }

  // 删除
  async function deleteExpense(row) {
    if (row.dataset.id) {
      await db.from("expenses").delete().eq("id", row.dataset.id);
    }
    row.remove();
    calculateSummary();
  }

  // 计算汇总
  function calculateSummary() {
    let total = 0;
    document.querySelectorAll("#expense-table tbody tr").forEach(row=>{
      total += parseFloat(row.querySelector(".amount-input").value)||0;
    });
    document.getElementById("total-expense").textContent = total.toFixed(2);
  }

  // 事件绑定
  document.getElementById("add-row").addEventListener("click", ()=>{
    const today = new Date().toISOString().split("T")[0];
    addRowToTable(today, "食物", "", "", null);
  });
  document.getElementById("month-select").addEventListener("change", loadExpenseData);
  document.getElementById("year-select").addEventListener("change", loadExpenseData);

  // 初始加载
  loadExpenseData();
</script>
</body>
</html>
