<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>æœˆåº¦èŠ±é”€è®°è´¦è¡¨ - äº‘ç«¯ç‰ˆ</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
* { box-sizing: border-box; }
body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont;
    background: #f5f6fa;
    margin: 0;
    padding: 16px;
}

.container {
    max-width: 1200px;
    margin: auto;
    background: #fff;
    border-radius: 12px;
    padding: 16px;
    box-shadow: 0 5px 15px rgba(0,0,0,.08);
}

h1 {
    text-align: center;
    margin-bottom: 16px;
}

/* ===== é…ç½®åŒº ===== */
.config-panel {
    background: #f8f9fa;
    padding: 16px;
    border-radius: 8px;
    margin-bottom: 16px;
    border-left: 4px solid #3498db;
}

.config-panel.hidden {
    display: none;
}

.config-input {
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    width: 100%;
    margin-bottom: 8px;
}

.config-btn {
    background: #3498db;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    margin-right: 8px;
}

.config-btn:hover {
    opacity: .9;
}

/* ===== æ§åˆ¶åŒº ===== */
.controls {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-bottom: 16px;
}

.controls select,
.controls button {
    padding: 8px 12px;
    border-radius: 6px;
    border: 1px solid #ddd;
    background: #fff;
}

.controls button {
    cursor: pointer;
    background: #3498db;
    color: #fff;
    border: none;
}

.controls button:hover {
    opacity: .9;
}

.controls button.green {
    background: #2ecc71;
}

.controls button.red {
    background: #e74c3c;
}

/* ===== çŠ¶æ€æç¤º ===== */
.status {
    padding: 10px;
    border-radius: 4px;
    margin: 10px 0;
    display: none;
}

.status.success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
    display: block;
}

.status.error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
    display: block;
}

.status.info {
    background: #d1ecf1;
    color: #0c5460;
    border: 1px solid #bee5eb;
    display: block;
}

/* ===== è‡ªå®šä¹‰ç±»å‹ ===== */
.custom-type {
    margin-bottom: 16px;
    padding: 12px;
    background: #f8f9fa;
    border-radius: 8px;
}

.custom-type input {
    padding: 8px;
    width: 160px;
    margin-right: 8px;
}

#type-list {
    margin-top: 8px;
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
}

.type-tag {
    background: #3498db;
    color: #fff;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    cursor: pointer;
    display: inline-block;
    margin-bottom: 4px;
}

/* ===== è¡¨æ ¼ ===== */
.table-wrap {
    overflow-x: auto;
}

table {
    border-collapse: collapse;
    width: 100%;
    min-width: 650px;
}

th, td {
    padding: 8px;
    border-bottom: 1px solid #ddd;
}

th {
    background: #f8f9fa;
}

input, select {
    width: 100%;
    padding: 4px;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.delete {
    background: #e74c3c;
    color: #fff;
    border: none;
    padding: 6px 8px;
    border-radius: 4px;
    cursor: pointer;
}

/* ===== ç»Ÿè®¡ ===== */
.summary {
    margin-top: 16px;
    background: #f8f9fa;
    padding: 12px;
    border-radius: 8px;
}

.summary strong {
    font-size: 18px;
}

/* ===== æ‰‹æœºé€‚é… ===== */
@media (max-width: 768px) {
    .controls, .config-buttons {
        flex-direction: column;
    }

    .controls select,
    .controls button,
    .config-btn {
        width: 100%;
        margin-bottom: 8px;
    }
    
    .config-btn {
        margin-right: 0;
    }
}
</style>
</head>

<body>
<div class="container">
    <h1>ğŸ“Š æœˆåº¦èŠ±é”€è®°è´¦è¡¨ - äº‘ç«¯ç‰ˆ</h1>
    
    <!-- é…ç½®é¢æ¿ -->
    <div class="config-panel" id="configPanel">
        <h3>ğŸ”§ Supabase é…ç½®</h3>
        <p>é¦–æ¬¡ä½¿ç”¨è¯·é…ç½®äº‘ç«¯å­˜å‚¨ï¼ˆé…ç½®ä¼šè‡ªåŠ¨ä¿å­˜ï¼‰</p>
        <input type="text" id="supabaseUrl" class="config-input" 
               placeholder="Supabase URL (å¦‚ï¼šhttps://xxx.supabase.co)">
        <input type="text" id="supabaseKey" class="config-input" 
               placeholder="Supabase Anon Key">
        <input type="text" id="tableName" class="config-input" 
               placeholder="è¡¨åï¼ˆé»˜è®¤ï¼šexpensesï¼‰" value="expenses">
        <div class="config-buttons">
            <button class="config-btn" onclick="saveConfig()">ğŸ’¾ ä¿å­˜é…ç½®</button>
            <button class="config-btn" onclick="testConnection()">ğŸ”— æµ‹è¯•è¿æ¥</button>
            <button class="config-btn" onclick="hideConfig()">éšè—é…ç½®</button>
        </div>
    </div>
    
    <!-- çŠ¶æ€æç¤º -->
    <div id="status" class="status"></div>
    
    <!-- æ§åˆ¶åŒº -->
    <div class="controls" id="mainControls" style="display:none;">
        <select id="year"></select>
        <select id="month"></select>
        <button id="addRow" class="green">ï¼‹ æ·»åŠ è®°å½•</button>
        <button id="export">ğŸ“¤ å¯¼å‡º Excel</button>
        <button onclick="syncData()" class="green">ğŸ”„ åŒæ­¥äº‘ç«¯</button>
        <button onclick="showConfig()" class="config-btn">âš™ï¸ é…ç½®</button>
    </div>

    <!-- è‡ªå®šä¹‰ç±»å‹ -->
    <div class="custom-type">
        <input id="newType" placeholder="æ–°å¢ç±»å‹" />
        <button onclick="addCustomType()" class="config-btn">æ·»åŠ ç±»å‹</button>
        <div id="type-list"></div>
    </div>

    <!-- è¡¨æ ¼ -->
    <div class="table-wrap">
        <table>
            <thead>
                <tr>
                    <th>æ—¥æœŸ</th>
                    <th>ç±»å‹</th>
                    <th>é‡‘é¢</th>
                    <th>å¤‡æ³¨</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="tbody"></tbody>
        </table>
    </div>

    <!-- ç»Ÿè®¡ -->
    <div class="summary">
        <strong>æ€»è®¡ï¼šÂ¥ <span id="total">0</span></strong>
        <div id="detail"></div>
    </div>
</div>

<script>
/* ========= å…¨å±€å˜é‡ ========= */
const baseTypes = ["é£Ÿç‰©", "å‡ºè¡Œ", "æ°´ç”µ", "æˆ¿ç§Ÿ", "è´­ç‰©", "å¨±ä¹", "åŒ»ç–—", "å…¶ä»–"];
let customTypes = JSON.parse(localStorage.getItem("customTypes") || "[]");
let expensesData = {}; // æœ¬åœ°ç¼“å­˜
let supabaseClient = null;
let currentConfig = null;

const yearEl = document.getElementById("year");
const monthEl = document.getElementById("month");
const tbody = document.getElementById("tbody");

/* ========= åˆå§‹åŒ– ========= */
function init() {
    // åˆå§‹åŒ–å¹´æœˆé€‰æ‹©
    const now = new Date();
    for (let y = now.getFullYear() - 5; y <= now.getFullYear() + 1; y++) {
        yearEl.add(new Option(y, y));
    }
    yearEl.value = now.getFullYear();

    ["1æœˆ","2æœˆ","3æœˆ","4æœˆ","5æœˆ","6æœˆ","7æœˆ","8æœˆ","9æœˆ","10æœˆ","11æœˆ","12æœˆ"].forEach((m,i)=>{
        monthEl.add(new Option(m, i));
    });
    monthEl.value = now.getMonth();
    
    // åŠ è½½é…ç½®
    loadConfig();
    renderTypes();
    
    // åˆå§‹åŒ–æœ¬åœ°æ•°æ®
    loadLocalData();
}

/* ========= é…ç½®ç®¡ç† ========= */
function loadConfig() {
    const savedConfig = localStorage.getItem('supabaseConfig');
    if (savedConfig) {
        currentConfig = JSON.parse(savedConfig);
        document.getElementById('supabaseUrl').value = currentConfig.url || '';
        document.getElementById('supabaseKey').value = currentConfig.key || '';
        document.getElementById('tableName').value = currentConfig.tableName || 'expenses';
        
        if (currentConfig.url && currentConfig.key) {
            initSupabase();
        }
    }
}

function saveConfig() {
    const url = document.getElementById('supabaseUrl').value.trim();
    const key = document.getElementById('supabaseKey').value.trim();
    const tableName = document.getElementById('tableName').value.trim() || 'expenses';

    if (!url || !key) {
        showStatus('è¯·å¡«å†™å®Œæ•´çš„é…ç½®ä¿¡æ¯', 'error');
        return;
    }

    currentConfig = { url, key, tableName };
    localStorage.setItem('supabaseConfig', JSON.stringify(currentConfig));
    showStatus('é…ç½®å·²ä¿å­˜ï¼', 'success');
    
    initSupabase();
}

function initSupabase() {
    try {
        supabaseClient = window.supabase.createClient(
            currentConfig.url,
            currentConfig.key
        );
        
        document.getElementById('configPanel').classList.add('hidden');
        document.getElementById('mainControls').style.display = 'flex';
        showStatus('äº‘ç«¯è¿æ¥æˆåŠŸï¼æ­£åœ¨åŠ è½½æ•°æ®...', 'success');
        
        // åŠ è½½äº‘ç«¯æ•°æ®
        loadCloudData();
    } catch (error) {
        showStatus('åˆå§‹åŒ–å¤±è´¥ï¼š' + error.message, 'error');
    }
}

function showConfig() {
    document.getElementById('configPanel').classList.remove('hidden');
}

function hideConfig() {
    document.getElementById('configPanel').classList.add('hidden');
}

async function testConnection() {
    const url = document.getElementById('supabaseUrl').value.trim();
    const key = document.getElementById('supabaseKey').value.trim();
    const tableName = document.getElementById('tableName').value.trim() || 'expenses';

    if (!url || !key) {
        showStatus('è¯·å…ˆå¡«å†™é…ç½®ä¿¡æ¯', 'error');
        return;
    }

    showStatus('æ­£åœ¨æµ‹è¯•è¿æ¥...', 'info');

    try {
        const testClient = window.supabase.createClient(url, key);
        const { data, error } = await testClient
          .from(tableName)
          .select('count', { count: 'exact', head: true });

        if (error) {
            if (error.message.includes('does not exist')) {
                showStatus(`è¡¨ "${tableName}" ä¸å­˜åœ¨ï¼Œæ˜¯å¦è‡ªåŠ¨åˆ›å»ºï¼Ÿ<button onclick="createTable()">åˆ›å»ºè¡¨</button>`, 'error');
            } else {
                showStatus('è¿æ¥å¤±è´¥ï¼š' + error.message, 'error');
            }
        } else {
            showStatus('âœ… è¿æ¥æˆåŠŸï¼å¯ä»¥ä¿å­˜é…ç½®äº†', 'success');
        }
    } catch (error) {
        showStatus('è¿æ¥æµ‹è¯•å¼‚å¸¸ï¼š' + error.message, 'error');
    }
}

/* ========= äº‘ç«¯è¡¨åˆ›å»º ========= */
async function createTable() {
    if (!supabaseClient) return;
    
    try {
        // å°è¯•åˆ›å»ºè¡¨ï¼ˆé€šè¿‡APIï¼‰
        const { error } = await supabaseClient
            .from('expenses')
            .insert([{
                id: 1,
                year: new Date().getFullYear(),
                month: new Date().getMonth(),
                data: JSON.stringify([]),
                created_at: new Date().toISOString()
            }]);
            
        if (error) {
            showStatus('åˆ›å»ºè¡¨å¤±è´¥ï¼Œè¯·åœ¨Supabaseä¸­æ‰‹åŠ¨åˆ›å»ºï¼š<br>' + 
                'è¡¨åï¼šexpenses<br>' +
                'å­—æ®µï¼šid(bigint), year(int), month(int), data(json), created_at(timestamp)', 'error');
        } else {
            showStatus('è¡¨åˆ›å»ºæˆåŠŸï¼', 'success');
            // åˆ é™¤æµ‹è¯•æ•°æ®
            await supabaseClient.from('expenses').delete().eq('id', 1);
        }
    } catch (err) {
        showStatus('åˆ›å»ºå¼‚å¸¸ï¼š' + err.message, 'error');
    }
}

/* ========= çŠ¶æ€æ˜¾ç¤º ========= */
function showStatus(message, type = 'info') {
    const statusDiv = document.getElementById('status');
    statusDiv.innerHTML = message;
    statusDiv.className = 'status ' + type;
    
    // 5ç§’åè‡ªåŠ¨éšè—
    if (type !== 'error') {
        setTimeout(() => {
            statusDiv.className = 'status';
        }, 5000);
    }
}

/* ========= ç±»å‹ç®¡ç† ========= */
function renderTypes() {
    const list = document.getElementById("type-list");
    list.innerHTML = "";
    customTypes.forEach(t => {
        const tag = document.createElement("div");
        tag.className = "type-tag";
        tag.textContent = t + " Ã—";
        tag.onclick = () => {
            customTypes = customTypes.filter(x => x !== t);
            localStorage.setItem("customTypes", JSON.stringify(customTypes));
            renderTypes();
            loadCurrentMonth();
        };
        list.appendChild(tag);
    });
}

function addCustomType() {
    const newTypeInput = document.getElementById("newType");
    const v = newTypeInput.value.trim();
    if (!v || baseTypes.includes(v) || customTypes.includes(v)) {
        showStatus('ç±»å‹å·²å­˜åœ¨æˆ–ä¸ºç©º', 'error');
        return;
    }
    customTypes.push(v);
    localStorage.setItem("customTypes", JSON.stringify(customTypes));
    newTypeInput.value = "";
    renderTypes();
    loadCurrentMonth();
    showStatus('ç±»å‹æ·»åŠ æˆåŠŸ', 'success');
}

/* ========= æ•°æ®ç®¡ç† ========= */
function getCurrentKey() {
    return `${yearEl.value}-${monthEl.value}`;
}

// æ·»åŠ è¡Œ
function addRow(data = {}) {
    const tr = document.createElement("tr");

    const typeOptions = [...baseTypes, ...customTypes]
        .map(t => `<option ${t===data.type?'selected':''}>${t}</option>`).join("");

    tr.innerHTML = `
        <td><input type="date" value="${data.date || new Date().toISOString().slice(0,10)}"></td>
        <td><select>${typeOptions}</select></td>
        <td><input type="number" step="0.01" value="${data.amount||''}" placeholder="0.00"></td>
        <td><input value="${data.note||''}" placeholder="å¤‡æ³¨"></td>
        <td><button class="delete">åˆ é™¤</button></td>
    `;

    tr.querySelector(".delete").onclick = () => {
        tr.remove();
        saveLocalData();
        syncData(); // åŒæ­¥åˆ°äº‘ç«¯
    };

    tr.querySelectorAll("input,select").forEach(el => el.oninput = () => {
        saveLocalData();
        syncData(); // è‡ªåŠ¨åŒæ­¥åˆ°äº‘ç«¯
    });
    
    tbody.appendChild(tr);
}

// ä¿å­˜æœ¬åœ°æ•°æ®
function saveLocalData() {
    const rows = [...tbody.children].map(tr => {
        const inputs = tr.querySelectorAll("input,select");
        return {
            date: inputs[0].value,
            type: inputs[1].value,
            amount: parseFloat(inputs[2].value) || 0,
            note: inputs[3].value
        };
    });
    
    const key = getCurrentKey();
    expensesData[key] = rows;
    localStorage.setItem('expensesData', JSON.stringify(expensesData));
    calc();
}

// åŠ è½½æœ¬åœ°æ•°æ®
function loadLocalData() {
    const saved = localStorage.getItem('expensesData');
    if (saved) {
        expensesData = JSON.parse(saved);
    }
    loadCurrentMonth();
}

// åŠ è½½å½“å‰æœˆä»½æ•°æ®
function loadCurrentMonth() {
    tbody.innerHTML = "";
    const key = getCurrentKey();
    const rows = expensesData[key] || [];
    rows.forEach(addRow);
    calc();
}

// ä»äº‘ç«¯åŠ è½½æ•°æ®
async function loadCloudData() {
    if (!supabaseClient || !currentConfig) return;
    
    try {
        const { data, error } = await supabaseClient
            .from(currentConfig.tableName)
            .select('*');
            
        if (error) {
            showStatus('åŠ è½½äº‘ç«¯æ•°æ®å¤±è´¥ï¼š' + error.message, 'error');
            return;
        }
        
        // åˆå¹¶äº‘ç«¯æ•°æ®åˆ°æœ¬åœ°
        if (data && data.length > 0) {
            data.forEach(item => {
                const key = `${item.year}-${item.month}`;
                try {
                    const cloudRows = JSON.parse(item.data || '[]');
                    const localRows = expensesData[key] || [];
                    
                    // åˆå¹¶æ•°æ®ï¼ˆäº‘ç«¯ä¼˜å…ˆï¼‰
                    const mergedRows = [...cloudRows];
                    localRows.forEach(localRow => {
                        if (!mergedRows.some(cloudRow => 
                            cloudRow.date === localRow.date && 
                            cloudRow.type === localRow.type &&
                            cloudRow.amount === localRow.amount &&
                            cloudRow.note === localRow.note
                        )) {
                            mergedRows.push(localRow);
                        }
                    });
                    
                    expensesData[key] = mergedRows;
                } catch (e) {
                    console.error('è§£æäº‘ç«¯æ•°æ®å¤±è´¥ï¼š', e);
                }
            });
            
            localStorage.setItem('expensesData', JSON.stringify(expensesData));
            loadCurrentMonth();
            showStatus('äº‘ç«¯æ•°æ®åŠ è½½å®Œæˆ', 'success');
        }
    } catch (error) {
        showStatus('åŠ è½½äº‘ç«¯æ•°æ®å¼‚å¸¸ï¼š' + error.message, 'error');
    }
}

// åŒæ­¥æ•°æ®åˆ°äº‘ç«¯
async function syncData() {
    if (!supabaseClient || !currentConfig) {
        showStatus('è¯·å…ˆé…ç½®äº‘ç«¯è¿æ¥', 'error');
        return;
    }
    
    showStatus('æ­£åœ¨åŒæ­¥åˆ°äº‘ç«¯...', 'info');
    
    try {
        // è·å–å½“å‰æœˆä»½æ•°æ®
        const key = getCurrentKey();
        const [year, month] = key.split('-');
        const rows = expensesData[key] || [];
        
        // æŸ¥è¯¢æ˜¯å¦å·²å­˜åœ¨è¯¥æœˆè®°å½•
        const { data: existing } = await supabaseClient
            .from(currentConfig.tableName)
            .select('id')
            .eq('year', parseInt(year))
            .eq('month', parseInt(month))
            .limit(1);
        
        if (existing && existing.length > 0) {
            // æ›´æ–°ç°æœ‰è®°å½•
            const { error } = await supabaseClient
                .from(currentConfig.tableName)
                .update({
                    data: JSON.stringify(rows),
                    updated_at: new Date().toISOString()
                })
                .eq('year', parseInt(year))
                .eq('month', parseInt(month));
                
            if (error) throw error;
        } else {
            // æ’å…¥æ–°è®°å½•
            const { error } = await supabaseClient
                .from(currentConfig.tableName)
                .insert({
                    year: parseInt(year),
                    month: parseInt(month),
                    data: JSON.stringify(rows),
                    created_at: new Date().toISOString()
                });
                
            if (error) throw error;
        }
        
        showStatus('âœ… åŒæ­¥æˆåŠŸï¼', 'success');
    } catch (error) {
        showStatus('åŒæ­¥å¤±è´¥ï¼š' + error.message, 'error');
    }
}

/* ========= ç»Ÿè®¡è®¡ç®— ========= */
function calc() {
    let total = 0;
    const map = {};
    [...tbody.children].forEach(tr => {
        const amt = parseFloat(tr.querySelectorAll("input")[1].value) || 0;
        const type = tr.querySelector("select").value;
        total += amt;
        map[type] = (map[type] || 0) + amt;
    });
    
    document.getElementById("total").textContent = total.toFixed(2);
    
    const detail = Object.entries(map)
        .map(([k, v]) => `${k}: Â¥${v.toFixed(2)}`)
        .join("<br>");
    document.getElementById("detail").innerHTML = detail || 'æš‚æ— åˆ†ç±»ç»Ÿè®¡';
}

/* ========= äº‹ä»¶ç»‘å®š ========= */
document.addEventListener('DOMContentLoaded', init);

document.getElementById("addRow").onclick = () => {
    addRow();
    saveLocalData();
    syncData();
};

yearEl.onchange = monthEl.onchange = loadCurrentMonth;

/* ========= Excelå¯¼å‡º ========= */
document.getElementById("export").onclick = () => {
    const data = [["æ—¥æœŸ", "ç±»å‹", "é‡‘é¢", "å¤‡æ³¨"]];
    [...tbody.children].forEach(tr => {
        const inputs = tr.querySelectorAll("input,select");
        data.push([
            inputs[0].value,
            inputs[1].value,
            inputs[2].value,
            inputs[3].value
        ]);
    });
    
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(data), "æœˆåº¦èŠ±é”€");
    XLSX.writeFile(wb, `${yearEl.value}å¹´${parseInt(monthEl.value) + 1}æœˆèŠ±é”€.xlsx`);
    showStatus('Excelå¯¼å‡ºæˆåŠŸï¼', 'success');
};
</script>
</body>
</html>
