<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æœˆåº¦èŠ±é”€è®°è´¦è¡¨ - Supabase ç‰ˆ</title>
  <style>
    /* ä¿ç•™åŸæœ‰æ ·å¼ï¼ˆç•¥å»éƒ¨åˆ†ï¼Œä¿æŒå’Œä½ ä¹‹å‰ä¸€æ ·ï¼‰ */
    body { font-family: sans-serif; padding: 20px; background: #f5f7fa; }
    .container { max-width: 1200px; margin: auto; background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    header { background: linear-gradient(90deg, #3498db, #2c3e50); color: white; padding: 20px; text-align: center; }
    h1 { margin: 0; }
    .controls, .summary, .export-section { padding: 20px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid #ddd; padding: 10px; }
    .delete-btn { background: #e74c3c; color: white; border: none; padding: 5px 10px; cursor: pointer; }
  </style>
</head>
<body>
<div class="container">
  <header>
    <h1>æœˆåº¦èŠ±é”€è®°è´¦è¡¨</h1>
    <p>æ•°æ®å­˜å‚¨åœ¨ Supabaseï¼Œæ”¯æŒå¤šè®¾å¤‡åŒæ­¥</p>
  </header>

  <div class="controls">
    <select id="month-select">
      <option value="0">ä¸€æœˆ</option><option value="1">äºŒæœˆ</option><option value="2">ä¸‰æœˆ</option>
      <option value="3">å››æœˆ</option><option value="4">äº”æœˆ</option><option value="5">å…­æœˆ</option>
      <option value="6">ä¸ƒæœˆ</option><option value="7">å…«æœˆ</option><option value="8">ä¹æœˆ</option>
      <option value="9">åæœˆ</option><option value="10">åä¸€æœˆ</option><option value="11">åäºŒæœˆ</option>
    </select>
    <select id="year-select"></select>
    <button id="add-row">+ æ·»åŠ è®°å½•</button>
  </div>

  <div class="table-container">
    <table id="expense-table">
      <thead>
        <tr>
          <th>æ—¥æœŸ</th><th>ç±»å‹</th><th>é‡‘é¢ (å…ƒ)</th><th>å¤‡æ³¨</th><th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="summary">
    <h2>èŠ±é”€ç»Ÿè®¡</h2>
    <p>æ€»èŠ±é”€: Â¥<span id="total-expense">0</span></p>
  </div>
</div>

<!-- å¼•å…¥ Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // ğŸš¨ æ›¿æ¢æˆä½ è‡ªå·±çš„ Supabase é¡¹ç›®å‚æ•°
  const SUPABASE_URL = "https://https://qumuqulin.github.io/expense-tracker/.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVpaGlpc2F2Y2pseGdqaWpyZWNyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwNzkwNjMsImV4cCI6MjA3MzY1NTA2M30.E5IsFrDr65nZoAlnkZN3XR8_QcIx9HSKu3Mc5kZwvI8";
  const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // åˆå§‹åŒ–å¹´ä»½é€‰æ‹©
  const yearSelect = document.getElementById('year-select');
  const currentYear = new Date().getFullYear();
  for (let y = currentYear - 2; y <= currentYear + 1; y++) {
    const opt = document.createElement('option');
    opt.value = y; opt.textContent = y; if (y === currentYear) opt.selected = true;
    yearSelect.appendChild(opt);
  }
  document.getElementById('month-select').value = new Date().getMonth();

  function getSelectedYearMonth() {
    return `${yearSelect.value}-${document.getElementById('month-select').value}`;
  }

  // åŠ è½½æ•°æ®
  async function loadExpenseData() {
    const tbody = document.querySelector('#expense-table tbody');
    tbody.innerHTML = "";
    let { data, error } = await db.from("expenses")
      .select("*")
      .eq("year_month", getSelectedYearMonth())
      .order("date", { ascending: true });
    if (error) { console.error(error); return; }
    data.forEach(exp => addRowToTable(exp.date, exp.type, exp.amount, exp.notes, exp.id));
    calculateSummary();
  }

  // æ·»åŠ è¡Œ
  function addRowToTable(date, type, amount, notes, id=null) {
    const tbody = document.querySelector('#expense-table tbody');
    const tr = document.createElement("tr");
    tr.dataset.id = id || "";
    tr.innerHTML = `
      <td><input type="date" value="${date||""}" class="date-input"></td>
      <td>
        <select class="type-select">
          <option value="æ°´" ${type==="æ°´"?"selected":""}>æ°´</option>
          <option value="é£Ÿç‰©" ${type==="é£Ÿç‰©"?"selected":""}>é£Ÿç‰©</option>
          <option value="å‡ºè¡Œ" ${type==="å‡ºè¡Œ"?"selected":""}>å‡ºè¡Œ</option>
          <option value="å…¶å®ƒ" ${type==="å…¶å®ƒ"?"selected":""}>å…¶å®ƒ</option>
        </select>
      </td>
      <td><input type="number" value="${amount||""}" class="amount-input" step="0.01"></td>
      <td><input type="text" value="${notes||""}" class="notes-input"></td>
      <td><button class="delete-btn">åˆ é™¤</button></td>
    `;
    tr.querySelectorAll("input,select").forEach(el=>{
      el.addEventListener("change", ()=>saveExpenseData(tr));
    });
    tr.querySelector(".delete-btn").addEventListener("click", ()=>deleteExpense(tr));
    tbody.appendChild(tr);
  }

  // ä¿å­˜æˆ–æ›´æ–°
  async function saveExpenseData(row) {
    const exp = {
      date: row.querySelector(".date-input").value,
      type: row.querySelector(".type-select").value,
      amount: parseFloat(row.querySelector(".amount-input").value)||0,
      notes: row.querySelector(".notes-input").value,
      year_month: getSelectedYearMonth()
    };
    if (!row.dataset.id) {
      let { data, error } = await db.from("expenses").insert([exp]).select();
      if (!error && data.length>0) row.dataset.id = data[0].id;
    } else {
      await db.from("expenses").update(exp).eq("id", row.dataset.id);
    }
    calculateSummary();
  }

  // åˆ é™¤
  async function deleteExpense(row) {
    if (row.dataset.id) {
      await db.from("expenses").delete().eq("id", row.dataset.id);
    }
    row.remove();
    calculateSummary();
  }

  // è®¡ç®—æ±‡æ€»
  function calculateSummary() {
    let total = 0;
    document.querySelectorAll("#expense-table tbody tr").forEach(row=>{
      total += parseFloat(row.querySelector(".amount-input").value)||0;
    });
    document.getElementById("total-expense").textContent = total.toFixed(2);
  }

  // äº‹ä»¶ç»‘å®š
  document.getElementById("add-row").addEventListener("click", ()=>{
    const today = new Date().toISOString().split("T")[0];
    addRowToTable(today, "é£Ÿç‰©", "", "", null);
  });
  document.getElementById("month-select").addEventListener("change", loadExpenseData);
  document.getElementById("year-select").addEventListener("change", loadExpenseData);

  // åˆå§‹åŠ è½½
  loadExpenseData();
</script>
</body>
</html>
