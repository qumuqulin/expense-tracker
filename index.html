<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æœˆåº¦èŠ±é”€è®°è´¦è¡¨ - è‡ªå®šä¹‰ç±»å‹</title>
<style>
* { box-sizing: border-box; margin:0; padding:0; }
body { font-family:'Segoe UI', Tahoma, Geneva, Verdana,sans-serif; background:#f5f7fa; padding:20px; }
.container { max-width:1200px; margin:0 auto; background:white; border-radius:12px; padding:20px; box-shadow:0 5px 15px rgba(0,0,0,0.1);}
header { text-align:center; margin-bottom:20px;}
h1 { font-size:2rem; margin-bottom:5px;}
.controls { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:10px; }
button { padding:8px 12px; border:none; border-radius:6px; cursor:pointer; background:#3498db; color:white; }
button:hover { background:#2980b9; }
.delete-btn { background:#e74c3c; }
.delete-btn:hover { background:#c0392b; }
.export-btn { background:#27ae60; }
.export-btn:hover { background:#219653; }
.table-container { overflow-x:auto; margin-bottom:20px; }
table { width:100%; border-collapse:collapse; min-width:600px; }
th, td { padding:10px; border-bottom:1px solid #ddd; text-align:left; }
.type-water { background:rgba(52,152,219,0.1);}
.type-food { background:rgba(46,204,113,0.1);}
.type-transport { background:rgba(155,89,182,0.1);}
.type-custom { background:rgba(241,196,15,0.1);}
.summary { background:#f8f9fa; padding:15px; border-radius:8px; }
.summary-item { background:white; padding:10px; border-radius:6px; margin-bottom:10px;}
.summary-item.total { background:#3498db; color:white; font-weight:bold; }
.notification { position:fixed; top:20px; right:20px; background:#27ae60; color:white; padding:10px 15px; border-radius:4px; transform:translateX(100%); transition:transform 0.3s ease; z-index:1000;}
.notification.show { transform:translateX(0);}
.notification.error { background:#e74c3c;}
#custom-types-list { display:flex; flex-wrap:wrap; gap:5px; margin-top:5px; }

/* æ‰‹æœºé€‚é… */
@media (max-width: 768px) {
    /* ä¿æŒåŸæœ‰çš„æ§åˆ¶å’Œè¾“å…¥æ¡†é€‚é… */
    .controls { flex-direction:column; align-items:stretch; }
    .month-year-select { display:flex; gap:10px; margin-bottom:10px; }
    .month-year-select select { flex:1; }
    .controls button { width:100%; }
    .custom-type-section input, .custom-type-section button { width:100%; margin-bottom:5px; }
    
    /* æ ¸å¿ƒè¡¨æ ¼ä¼˜åŒ–ï¼šå“åº”å¼å †å å¸ƒå±€ */
    .table-container { 
        overflow-x: hidden; /* åœ¨å°å±å¹•ä¸Šå–æ¶ˆæ°´å¹³æ»šåŠ¨ */
    }
    table {
        min-width: unset; /* å–æ¶ˆè¡¨æ ¼çš„æœ€å°å®½åº¦é™åˆ¶ */
    }
    table, thead, tbody, th, td, tr {
        display: block; /* æ‰€æœ‰è¡¨æ ¼å…ƒç´ éƒ½å˜ä¸ºå—çº§å…ƒç´  */
    }

    /* éšè—è¡¨å¤´ */
    thead tr {
        position: absolute;
        top: -9999px;
        left: -9999px;
    }

    /* ä¼˜åŒ–è¡¨æ ¼è¡Œ (æ¯æ¡è®°å½•) */
    tr {
        border: 1px solid #ccc; /* ç»™æ¯æ¡è®°å½•åŠ è¾¹æ¡†ï¼Œä½¿å…¶æ›´åƒä¸€ä¸ªå¡ç‰‡ */
        margin-bottom: 10px;
        border-radius: 8px;
        overflow: hidden; 
        padding: 0; /* æ¸…é™¤é»˜è®¤å†…è¾¹è· */
    }

    /* ä¼˜åŒ–è¡¨æ ¼å•å…ƒæ ¼ (æ¯æ¡è®°å½•ä¸­çš„å­—æ®µ) */
    td {
        border: none;
        border-bottom: 1px solid #eee; /* ç”¨ç»†çº¿åˆ†éš”å­—æ®µ */
        position: relative;
        padding-left: 50%; /* ç•™å‡ºç©ºé—´ç»™ä¼ªå…ƒç´ æ ‡é¢˜ */
        text-align: right;
        min-height: 40px; /* ç¡®ä¿æœ‰è¶³å¤Ÿçš„ç©ºé—´ */
    }
    
    /* ç¡®ä¿è¾“å…¥æ¡†å’Œé€‰æ‹©æ¡†åœ¨å³ä¾§å±…ä¸­å¯¹é½ */
    td input, td select {
        width: 100%;
        text-align: right;
        border: none;
        padding: 0;
        margin: 0;
        line-height: 1.2;
        background: transparent; /* ä¿æŒè¾“å…¥æ¡†èƒŒæ™¯é€æ˜ï¼Œä½¿å…¶çœ‹èµ·æ¥æ˜¯å•å…ƒæ ¼çš„ä¸€éƒ¨åˆ† */
    }

    /* ä½¿ç”¨ä¼ªå…ƒç´ æ˜¾ç¤ºæ ‡é¢˜ (æ•°æ®æ ‡ç­¾) */
    td::before {
        content: attr(data-label); /* è·å–è‡ªå®šä¹‰çš„data-labelå±æ€§ä½œä¸ºæ ‡é¢˜ */
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        width: 40%;
        padding-right: 10px;
        white-space: nowrap;
        text-align: left;
        font-weight: bold;
        color: #555;
    }
    
    /* çªå‡ºæ“ä½œæŒ‰é’® */
    td:last-child {
        text-align: center;
        padding: 10px;
        border-bottom: none;
    }
    td:last-child button {
        width: 50%;
        max-width: 200px;
    }
}
</style>

<!-- ========== Supabase + è´¦å·ç™»å½•ç³»ç»Ÿ ========== -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// === é…ç½® ===
const SUPABASE_URL = 'https://lhmegseratwrdomkuikk.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIs...'; // ä½ çš„ anon key

// åˆå§‹åŒ–å®¢æˆ·ç«¯
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// === ç™»å½•çŠ¶æ€ç®¡ç† ===
let currentUser = null;

// åˆå§‹åŒ–ï¼šæ£€æŸ¥ç™»å½•çŠ¶æ€
async function initAuth() {
    const { data: { session } } = await supabase.auth.getSession();
    if (session) {
        currentUser = session.user;
        updateUIForLoggedInUser();
        console.log('ç”¨æˆ·å·²ç™»å½•:', currentUser.email);
        return true;
    }
    return false;
}

// === UI æ›´æ–°å‡½æ•° ===
function updateUIForLoggedInUser() {
    const container = document.querySelector('.container');
    
    // æ·»åŠ ç”¨æˆ·ä¿¡æ¯æ 
    let userBar = document.getElementById('user-info-bar');
    if (!userBar) {
        userBar = document.createElement('div');
        userBar.id = 'user-info-bar';
        userBar.style.cssText = `
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        `;
        container.insertBefore(userBar, container.firstChild);
    }
    
    const email = currentUser.email || 'ç”¨æˆ·';
    userBar.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px;">
            <div style="background: white; color: #764ba2; width: 36px; height: 36px; border-radius: 50%; 
                        display: flex; align-items: center; justify-content: center; font-weight: bold;">
                ${email.charAt(0).toUpperCase()}
            </div>
            <div>
                <div style="font-weight: bold;">${email}</div>
                <div style="font-size: 0.85em; opacity: 0.9;">æ•°æ®å·²äº‘ç«¯åŒæ­¥</div>
            </div>
        </div>
        <button id="logout-btn" style="
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        ">é€€å‡ºç™»å½•</button>
    `;
    
    document.getElementById('logout-btn').addEventListener('click', logout);
}

function updateUIForLoggedOutUser() {
    const container = document.querySelector('.container');
    
    // ç§»é™¤ç”¨æˆ·ä¿¡æ¯æ 
    const userBar = document.getElementById('user-info-bar');
    if (userBar) userBar.remove();
    
    // æ·»åŠ ç™»å½•/æ³¨å†Œè¡¨å•
    let authForm = document.getElementById('auth-form');
    if (!authForm) {
        authForm = document.createElement('div');
        authForm.id = 'auth-form';
        authForm.style.cssText = `
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
        `;
        container.insertBefore(authForm, container.firstChild);
        
        authForm.innerHTML = `
            <h2 style="margin-bottom: 20px; color: #333; display: flex; align-items: center; gap: 10px;">
                <span style="color: #667eea;">ğŸ”</span> ç™»å½• / æ³¨å†Œ
            </h2>
            <div style="margin-bottom: 15px;">
                <input type="email" id="auth-email" placeholder="é‚®ç®±åœ°å€" style="
                    width: 100%;
                    padding: 12px;
                    border: 2px solid #e0e0e0;
                    border-radius: 8px;
                    margin-bottom: 10px;
                    font-size: 16px;
                    transition: border 0.3s;
                ">
                <input type="password" id="auth-password" placeholder="å¯†ç " style="
                    width: 100%;
                    padding: 12px;
                    border: 2px solid #e0e0e0;
                    border-radius: 8px;
                    margin-bottom: 15px;
                    font-size: 16px;
                    transition: border 0.3s;
                ">
                <div style="display: flex; gap: 10px;">
                    <button id="login-btn" style="
                        flex: 1;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        padding: 12px;
                        border: none;
                        border-radius: 8px;
                        font-weight: bold;
                        cursor: pointer;
                        transition: transform 0.2s;
                    ">ç™»å½•</button>
                    <button id="signup-btn" style="
                        flex: 1;
                        background: white;
                        color: #667eea;
                        padding: 12px;
                        border: 2px solid #667eea;
                        border-radius: 8px;
                        font-weight: bold;
                        cursor: pointer;
                        transition: all 0.2s;
                    ">æ³¨å†Œ</button>
                </div>
            </div>
            <div id="auth-message" style="
                padding: 10px;
                border-radius: 6px;
                margin-top: 10px;
                display: none;
            "></div>
            <div style="text-align: center; margin-top: 15px; font-size: 14px; color: #666;">
                ç™»å½•åæ•°æ®å°†è‡ªåŠ¨ä¿å­˜åˆ°äº‘ç«¯ï¼Œå¯åœ¨ä»»ä½•è®¾å¤‡è®¿é—®
            </div>
        `;
        
        // æ·»åŠ äº‹ä»¶ç›‘å¬
        document.getElementById('login-btn').addEventListener('click', login);
        document.getElementById('signup-btn').addEventListener('click', signup);
        
        // æŒ‰å›è½¦é”®ç™»å½•
        document.getElementById('auth-password').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') login();
        });
    }
}

// === ç™»å½•/æ³¨å†ŒåŠŸèƒ½ ===
async function login() {
    const email = document.getElementById('auth-email').value.trim();
    const password = document.getElementById('auth-password').value;
    const messageDiv = document.getElementById('auth-message');
    
    if (!email || !password) {
        showAuthMessage('è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç ', 'error');
        return;
    }
    
    showAuthMessage('ç™»å½•ä¸­...', 'info');
    
    try {
        const { data, error } = await supabase.auth.signInWithPassword({
            email,
            password
        });
        
        if (error) throw error;
        
        currentUser = data.user;
        showAuthMessage('ç™»å½•æˆåŠŸï¼', 'success');
        setTimeout(() => {
            updateUIForLoggedInUser();
            // åŠ è½½äº‘ç«¯æ•°æ®
            loadFromCloud();
        }, 1000);
        
    } catch (error) {
        showAuthMessage(error.message || 'ç™»å½•å¤±è´¥', 'error');
    }
}

async function signup() {
    const email = document.getElementById('auth-email').value.trim();
    const password = document.getElementById('auth-password').value;
    const messageDiv = document.getElementById('auth-message');
    
    if (!email || !password) {
        showAuthMessage('è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç ', 'error');
        return;
    }
    
    if (password.length < 6) {
        showAuthMessage('å¯†ç è‡³å°‘6ä½', 'error');
        return;
    }
    
    showAuthMessage('æ³¨å†Œä¸­...', 'info');
    
    try {
        const { data, error } = await supabase.auth.signUp({
            email,
            password,
            options: {
                emailRedirectTo: 'https://qumuqulin.github.io/expense-tracker/'
            }
        });
        
        if (error) throw error;
        
        showAuthMessage('æ³¨å†ŒæˆåŠŸï¼è¯·æ£€æŸ¥é‚®ç®±éªŒè¯ï¼ˆå¦‚éœ€è¦ï¼‰', 'success');
        currentUser = data.user;
        
        setTimeout(() => {
            updateUIForLoggedInUser();
        }, 1500);
        
    } catch (error) {
        showAuthMessage(error.message || 'æ³¨å†Œå¤±è´¥', 'error');
    }
}

async function logout() {
    await supabase.auth.signOut();
    currentUser = null;
    updateUIForLoggedOutUser();
    showNotification('å·²é€€å‡ºç™»å½•');
    // æ¸…é™¤æœ¬åœ°æ•°æ®ï¼ˆå¯é€‰ï¼‰
    // localStorage.clear();
}

// === äº‘åŒæ­¥åŠŸèƒ½ ===
async function saveToCloud(expensesData) {
    if (!currentUser) return;
    
    try {
        const year = document.getElementById('year-select').value;
        const month = (parseInt(document.getElementById('month-select').value) + 1)
            .toString().padStart(2, '0');
        const monthYear = `${year}-${month}`;
        
        const { error } = await supabase
            .from('expenses')
            .upsert({
                user_id: currentUser.id,
                month_year: monthYear,
                data: expensesData,
                updated_at: new Date().toISOString()
            }, {
                onConflict: 'user_id,month_year'
            });
        
        if (error) throw error;
        
        console.log('âœ… æ•°æ®å·²ä¿å­˜åˆ°äº‘ç«¯');
        return true;
        
    } catch (error) {
        console.error('ä¿å­˜åˆ°äº‘ç«¯å¤±è´¥:', error.message);
        return false;
    }
}

async function loadFromCloud() {
    if (!currentUser) return null;
    
    try {
        const year = document.getElementById('year-select').value;
        const month = (parseInt(document.getElementById('month-select').value) + 1)
            .toString().padStart(2, '0');
        const monthYear = `${year}-${month}`;
        
        const { data, error } = await supabase
            .from('expenses')
            .select('data')
            .eq('user_id', currentUser.id)
            .eq('month_year', monthYear)
            .single();
        
        if (error) {
            if (error.code === 'PGRST116') return null; // æ— æ•°æ®
            throw error;
        }
        
        console.log('âœ… ä»äº‘ç«¯åŠ è½½æ•°æ®æˆåŠŸ');
        return data.data;
        
    } catch (error) {
        console.error('ä»äº‘ç«¯åŠ è½½å¤±è´¥:', error.message);
        return null;
    }
}

// === å·¥å…·å‡½æ•° ===
function showAuthMessage(message, type = 'info') {
    const messageDiv = document.getElementById('auth-message');
    if (!messageDiv) return;
    
    messageDiv.textContent = message;
    messageDiv.style.display = 'block';
    messageDiv.style.background = 
        type === 'error' ? '#fee' : 
        type === 'success' ? '#efc' : '#eef';
    messageDiv.style.color = 
        type === 'error' ? '#c33' : 
        type === 'success' ? '#363' : '#336';
    messageDiv.style.border = `1px solid ${
        type === 'error' ? '#fcc' : 
        type === 'success' ? '#cfc' : '#ccf'
    }`;
}

// === åˆå§‹åŒ– ===
document.addEventListener('DOMContentLoaded', async function() {
    // ç­‰å¾…é¡µé¢åŠ è½½
    setTimeout(async () => {
        const isLoggedIn = await initAuth();
        
        if (!isLoggedIn) {
            updateUIForLoggedOutUser();
            console.log('ç”¨æˆ·æœªç™»å½•ï¼Œæ˜¾ç¤ºç™»å½•ç•Œé¢');
        } else {
            // å·²ç™»å½•ï¼ŒåŠ è½½äº‘ç«¯æ•°æ®
            const cloudData = await loadFromCloud();
            if (cloudData) {
                // ä¸æœ¬åœ°æ•°æ®åˆå¹¶æˆ–æ›¿æ¢ï¼ˆæ ¹æ®ä½ çš„éœ€æ±‚ï¼‰
                const localKey = getSelectedYearMonth();
                const localData = JSON.parse(localStorage.getItem(localKey) || '[]');
                
                if (localData.length === 0 || confirm('æ£€æµ‹åˆ°äº‘ç«¯æ•°æ®ï¼Œæ˜¯å¦è¦†ç›–æœ¬åœ°æ•°æ®ï¼Ÿ')) {
                    const tbody = document.querySelector('#expense-table tbody');
                    if (tbody) {
                        tbody.innerHTML = '';
                        cloudData.forEach(d => {
                            addRowToTable(d.date, d.type, d.amount, d.notes, d.id);
                        });
                        calculateSummary();
                        showNotification('å·²ä»äº‘ç«¯æ¢å¤æ•°æ®');
                    }
                }
            }
        }
        
        // ä¿®æ”¹ä¿å­˜å‡½æ•°ï¼Œæ·»åŠ äº‘ç«¯åŒæ­¥
        const originalSaveExpenseData = window.saveExpenseData;
        if (originalSaveExpenseData) {
            window.saveExpenseData = function() {
                // ä¿å­˜åˆ°æœ¬åœ°
                originalSaveExpenseData.call(this);
                
                // å¦‚æœå·²ç™»å½•ï¼Œä¿å­˜åˆ°äº‘ç«¯
                if (currentUser) {
                    const rows = document.querySelectorAll('#expense-table tbody tr');
                    const data = Array.from(rows).map(r => ({
                        id: r.dataset.id,
                        date: r.querySelector('.date-input').value,
                        type: r.querySelector('.type-select').value,
                        amount: parseFloat(r.querySelector('.amount-input').value) || 0,
                        notes: r.querySelector('.notes-input').value
                    }));
                    
                    if (data.length > 0) {
                        saveToCloud(data);
                    }
                }
            };
        }
    }, 500);
    
    // ç›‘å¬è®¤è¯çŠ¶æ€å˜åŒ–
    supabase.auth.onAuthStateChange((event, session) => {
        console.log('è®¤è¯çŠ¶æ€å˜åŒ–:', event);
        if (event === 'SIGNED_IN' && session) {
            currentUser = session.user;
            updateUIForLoggedInUser();
            loadFromCloud();
        } else if (event === 'SIGNED_OUT') {
            currentUser = null;
            updateUIForLoggedOutUser();
        }
    });
});
</script>
<!-- ========== è´¦å·ç™»å½•ç³»ç»Ÿç»“æŸ ========== -->

</head>

<body>
<div class="container">
    <header>
        <h1>æœˆåº¦èŠ±é”€è®°è´¦è¡¨</h1>
    </header>

    <div class="controls">
        <div class="month-year-select">
            <select id="month-select"></select>
            <select id="year-select"></select>
        </div>
        <div>
            <button id="add-row">+ æ·»åŠ è®°å½•</button>
            <button id="export-xlsx" class="export-btn">å¯¼å‡º Excel</button>
        </div>
    </div>

    <div class="custom-type-section">
        <input type="text" id="new-type-input" placeholder="è¾“å…¥æ–°çš„èŠ±é”€ç±»å‹">
        <button id="add-type">æ·»åŠ ç±»å‹</button>
        <div id="custom-types-list"></div>
    </div>

    <div class="table-container">
        <table id="expense-table">
            <thead>
                <tr>
                    <th>æ—¥æœŸ</th>
                    <th>ç±»å‹</th>
                    <th>é‡‘é¢</th>
                    <th>å¤‡æ³¨</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="summary" id="summary-grid">
        <div class="summary-item total">
            æ€»èŠ±é”€: Â¥<span id="total-expense">0</span>
        </div>
    </div>
</div>

<div class="notification" id="notification"></div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const expenseTypes = ['æ°´','é£Ÿç‰©','å‡ºè¡Œ'];
    let customTypes = [];

    const monthSelect = document.getElementById('month-select');
    const yearSelect = document.getElementById('year-select');

    // åˆå§‹åŒ–æœˆä»½
    ['ä¸€æœˆ','äºŒæœˆ','ä¸‰æœˆ','å››æœˆ','äº”æœˆ','å…­æœˆ','ä¸ƒæœˆ','å…«æœˆ','ä¹æœˆ','åæœˆ','åä¸€æœˆ','åäºŒæœˆ'].forEach((m,i)=>{
        const opt = document.createElement('option'); opt.value=i; opt.textContent=m; monthSelect.appendChild(opt);
    });
    monthSelect.value = new Date().getMonth();

    // åˆå§‹åŒ–å¹´ä»½
    const currentYear = new Date().getFullYear();
    for(let y=currentYear-5;y<=currentYear+1;y++){
        const opt = document.createElement('option'); opt.value=y; opt.textContent=y; if(y===currentYear) opt.selected=true; yearSelect.appendChild(opt);
    }

    loadCustomTypes();
    loadExpenseData();
    calculateSummary();

    document.getElementById('add-row').addEventListener('click', addNewRow);
    document.getElementById('add-type').addEventListener('click', addCustomType);
    monthSelect.addEventListener('change', loadExpenseData);
    yearSelect.addEventListener('change', loadExpenseData);
    document.getElementById('export-xlsx').addEventListener('click', generateXLSX);

    function showNotification(msg, isError=false){
        const n=document.getElementById('notification'); n.textContent=msg; n.classList.remove('error'); if(isError) n.classList.add('error'); n.classList.add('show');
        setTimeout(()=>n.classList.remove('show'),3000);
    }

    function getSelectedYearMonth(){ 
        const month=(parseInt(monthSelect.value)+1).toString().padStart(2,'0'); 
        return `${yearSelect.value}-${month}`; 
    }
    function getSelectedYearMonthText(){ 
        const monthNames=['ä¸€æœˆ','äºŒæœˆ','ä¸‰æœˆ','å››æœˆ','äº”æœˆ','å…­æœˆ','ä¸ƒæœˆ','å…«æœˆ','ä¹æœˆ','åæœˆ','åä¸€æœˆ','åäºŒæœˆ'];
        return `${yearSelect.value}å¹´${monthNames[parseInt(monthSelect.value)]}`;
    }

    function loadCustomTypes(){
        const saved = localStorage.getItem('customExpenseTypes');
        if(saved) customTypes = JSON.parse(saved);
        updateCustomTypesDisplay();
    }
    function saveCustomTypes(){ localStorage.setItem('customExpenseTypes', JSON.stringify(customTypes)); }
    function updateCustomTypesDisplay(){
        const list=document.getElementById('custom-types-list'); list.innerHTML='';
        customTypes.forEach(type=>{
            const tag=document.createElement('div'); tag.style.display='inline-block'; tag.style.marginRight='5px';
            tag.style.background='#3498db'; tag.style.color='white'; tag.style.padding='3px 8px'; tag.style.borderRadius='10px';
            tag.innerHTML=`${type} <span style="cursor:pointer;" data-type="${type}">Ã—</span>`;
            list.appendChild(tag);
        });
        document.querySelectorAll('#custom-types-list span').forEach(sp=>sp.addEventListener('click',()=>{ removeCustomType(sp.dataset.type); }));
    }
    function addCustomType(){
        const input=document.getElementById('new-type-input'); const t=input.value.trim(); if(!t){showNotification('è¯·è¾“å…¥ç±»å‹',true); return;}
        if(expenseTypes.includes(t) || customTypes.includes(t)){showNotification('ç±»å‹å·²å­˜åœ¨',true); return;}
        customTypes.push(t); saveCustomTypes(); updateCustomTypesDisplay(); input.value=''; showNotification(`ç±»å‹ "${t}" æ·»åŠ æˆåŠŸ`);
        updateTypeSelects();
    }
    function removeCustomType(t){ customTypes=customTypes.filter(x=>x!==t); saveCustomTypes(); updateCustomTypesDisplay(); loadExpenseData(); showNotification(`ç±»å‹ "${t}" å·²åˆ é™¤`); }

    function addNewRow(){
        const today=new Date();
        const date=`${today.getFullYear()}-${(today.getMonth()+1).toString().padStart(2,'0')}-${today.getDate().toString().padStart(2,'0')}`;
        // æ–°è®°å½•é»˜è®¤ç±»å‹è®¾ä¸ºâ€œé£Ÿç‰©â€
        addRowToTable(date,'é£Ÿç‰©','', '', Date.now()); 
    }

    function addRowToTable(date,type,amount,notes,id){
        const tbody=document.querySelector('#expense-table tbody'); 
        const row=document.createElement('tr'); row.dataset.id=id;
        const typeClass=getTypeClass(type); row.className=`type-${typeClass}`;
        
        // **ã€ä¿®æ”¹ç‚¹ã€‘**ï¼šä¸ºæ¯ä¸ª <td> æ·»åŠ  data-label å±æ€§ï¼Œç”¨äºæ‰‹æœºç«¯æ˜¾ç¤ºæ ‡ç­¾
        row.innerHTML=`
            <td data-label="æ—¥æœŸ"><input type="date" value="${date}" class="date-input"></td>
            <td data-label="ç±»å‹"><select class="type-select"></select></td>
            <td data-label="é‡‘é¢"><input type="number" value="${amount}" class="amount-input" min="0" step="0.01"></td>
            <td data-label="å¤‡æ³¨"><input type="text" value="${notes}" class="notes-input"></td>
            <td data-label="æ“ä½œ"><button class="delete-btn">åˆ é™¤</button></td>
        `;
        // **ã€ä¿®æ”¹ç‚¹ç»“æŸã€‘**

        const select=row.querySelector('.type-select'); updateSingleTypeSelect(select,type);
        row.querySelectorAll('input, select').forEach(el=>el.addEventListener('input', saveExpenseData));
        row.querySelector('.delete-btn').addEventListener('click',()=>{ row.remove(); saveExpenseData(); });
        tbody.appendChild(row);
        saveExpenseData();
    }

    function updateSingleTypeSelect(select,val){
        const all=[...expenseTypes,...customTypes]; select.innerHTML=''; all.forEach(t=>{ const opt=document.createElement('option'); opt.value=t; opt.textContent=t; if(t===val) opt.selected=true; select.appendChild(opt); });
        select.addEventListener('change', saveExpenseData);
    }

    function updateTypeSelects(){
        document.querySelectorAll('.type-select').forEach(s=>{ const val=s.value; updateSingleTypeSelect(s,val); });
    }

    function getTypeClass(t){ if(t==='æ°´') return 'water'; if(t==='é£Ÿç‰©') return 'food'; if(t==='å‡ºè¡Œ') return 'transport'; return 'custom'; }

    function saveExpenseData(){
        const rows=document.querySelectorAll('#expense-table tbody tr');
        const data=Array.from(rows).map(r=>({
            id:r.dataset.id, date:r.querySelector('.date-input').value,
            type:r.querySelector('.type-select').value,
            amount:parseFloat(r.querySelector('.amount-input').value)||0,
            notes:r.querySelector('.notes-input').value
        }));
        localStorage.setItem(getSelectedYearMonth(),JSON.stringify(data));
        calculateSummary();

        // è°ƒç”¨äº‘ä¿å­˜å‡½æ•°
        if (typeof saveToCloud === 'function') {
            saveToCloud(data);
        }

    }

    function loadExpenseData(){
        const tbody=document.querySelector('#expense-table tbody'); tbody.innerHTML='';
        const key=getSelectedYearMonth();
        const data=JSON.parse(localStorage.getItem(key))||[];
        data.forEach(d=>addRowToTable(d.date,d.type,d.amount,d.notes,d.id));
        calculateSummary();
    }

    function calculateSummary(){
        const rows=document.querySelectorAll('#expense-table tbody tr');
        let total=0; const typeMap={}; [...expenseTypes,...customTypes].forEach(t=>typeMap[t]={amount:0,count:0});
        rows.forEach(r=>{ const amt=parseFloat(r.querySelector('.amount-input').value)||0; const t=r.querySelector('.type-select').value; total+=amt; if(!typeMap[t]) typeMap[t]={amount:0,count:0}; typeMap[t].amount+=amt; typeMap[t].count+=1; });
        const grid=document.getElementById('summary-grid'); const totalDiv=grid.querySelector('.total'); grid.innerHTML=''; grid.appendChild(totalDiv); document.getElementById('total-expense').textContent=total.toFixed(2);
        Object.keys(typeMap).forEach(t=>{ const d=typeMap[t]; if(d.count>0){ const div=document.createElement('div'); div.className='summary-item'; div.innerHTML=`${t}: Â¥${d.amount.toFixed(2)} (æ¬¡æ•°:${d.count})`; grid.appendChild(div); }});
    }

    function generateXLSX(){
        try{
            const monthYear=getSelectedYearMonthText();
            const rows=document.querySelectorAll('#expense-table tbody tr');
            const data=[["æ—¥æœŸ","ç±»å‹","é‡‘é¢","å¤‡æ³¨"]];
            rows.forEach(r=>{ data.push([r.querySelector('.date-input').value,r.querySelector('.type-select').value,r.querySelector('.amount-input').value,r.querySelector('.notes-input').value]); });
            const wb=XLSX.utils.book_new(); const ws=XLSX.utils.aoa_to_sheet(data);
            ws['!cols']=[{wch:15},{wch:15},{wch:12},{wch:40}];
            XLSX.utils.book_append_sheet(wb,ws,"èŠ±é”€è®°å½•"); XLSX.writeFile(wb,`${monthYear}èŠ±é”€è®°å½•.xlsx`);
            showNotification("Excel å¯¼å‡ºæˆåŠŸï¼");
        }catch(e){ console.error(e); showNotification("Excel å¯¼å‡ºå¤±è´¥",true); }
    }
});
</script>
</body>
</html>

